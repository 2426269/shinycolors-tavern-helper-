# 如何调试技能卡生成问题

## 🔍 查看详细调试信息的步骤

### 1. 打开浏览器开发者工具
在 SillyTavern 的浏览器窗口中：
- **Windows/Linux**: 按 `F12` 键
- **Mac**: 按 `Cmd + Option + I`

### 2. 切换到控制台（Console）标签
点击顶部的 **Console** 标签

### 3. 清空控制台
点击左上角的 🚫 图标清空之前的日志

### 4. 开始生成技能卡
在 SillyTavern 中点击"生成技能卡"按钮

### 5. 查看关键日志输出

#### ✅ 正常流程应该看到：
```
🎨 开始生成技能卡... {characterName: "xxx", ...}
📚 组装系统提示词...
✅ 系统提示词已组装，长度: XXXX 字符
🤖 调用AI生成...
📝 AI原始输出（前500字符）: {...}
🔍 解析AI输出...
📦 解析后的AI卡片数据（完整对象）: {id: "xxx", nameJP: "xxx", ...}
📋 数据结构分析: {hasId: true, effectEntriesLength: 3, ...}
📋 第一个效果词条: {icon: "...", effect: "...", isConsumption: false}
✅ 验证技能卡格式...
✅ 技能卡验证通过
🔄 转换为战斗系统格式...
🎉 技能卡生成成功！
```

#### ❌ 如果出错，会看到：
```
❌ 技能卡验证失败（原始错误）: ZodError {...}
错误类型: ZodError
❌ 技能卡验证失败（Zod错误）: [{path: [...], message: "..."}]
📋 格式化的错误信息:
  字段 "effectEntries": 效果词条不能为空数组
  字段 "restrictions.isDuplicatable": Required
```

### 6. 在控制台中手动查看数据

#### 查看 AI 原始输出：
在控制台中输入并按回车：
```javascript
window.__lastAIOutput
```
这会显示 AI 返回的完整原始文本

#### 查看解析后的 JSON 对象：
```javascript
window.__lastParsedCard
```
这会显示解析后的技能卡 JSON 对象

#### 展开查看 effectEntries：
```javascript
window.__lastParsedCard.effectEntries
```

#### 查看第一个效果词条：
```javascript
window.__lastParsedCard.effectEntries[0]
```

### 7. 常见问题诊断

#### 问题1：⚠️ effectEntries 为空或不存在！
**症状**: 控制台显示警告 "effectEntries 为空或不存在"

**原因**: AI 没有按照词条式格式输出

**排查步骤**:
1. 查看 `window.__lastAIOutput` 看 AI 实际输出了什么
2. 查看 `window.__lastParsedCard` 看解析后的结构
3. 检查 AI 是否使用了旧的 `effect` 字段而不是 `effectEntries` 数组

**解决方法**:
- AI 可能没有理解词条式格式
- 检查提示词中的示例卡是否正确
- 可能需要重新生成

#### 问题2：❌ 技能卡验证失败
**症状**: 控制台显示 "技能卡验证失败"

**原因**: AI 输出的 JSON 字段不符合要求

**排查步骤**:
1. 查看 "📋 格式化的错误信息" 了解具体哪个字段有问题
2. 查看 `window.__lastParsedCard` 检查实际的数据结构
3. 对照 Schema 检查缺失或错误的字段

**常见错误**:
- `effectEntries` 是空数组 `[]`
- 缺少 `restrictions` 字段
- `icon` URL 格式不正确
- `isConsumption` 不是布尔值

#### 问题3：Cannot read properties of undefined (reading 'map')
**症状**: 错误堆栈显示 "Cannot read properties of undefined"

**原因**: 代码试图对 `undefined` 调用 `.map()`

**已修复**:
- 添加了防御性编程检查
- 确保所有数组操作前都检查是否存在
- 重新编译项目应该已修复

### 8. 复制完整日志
如果需要报告问题：
1. 右键点击控制台
2. 选择 "Save as..." 保存完整日志
3. 或者选择所有文本（Ctrl+A）并复制

### 9. 查看网络请求（可选）
如果怀疑是 AI 调用问题：
1. 切换到 **Network** 标签
2. 刷新页面或重新生成
3. 查找发送给 AI 的请求
4. 点击查看请求详情和响应内容

---

## 📝 调试 Checklist

生成失败时，按顺序检查：

- [ ] 控制台是否有红色错误？
- [ ] 是否看到 "📦 解析后的AI卡片数据" 日志？
- [ ] `effectEntriesLength` 是否 > 0？
- [ ] 是否看到 "⚠️ effectEntries 为空" 警告？
- [ ] 验证失败的具体错误信息是什么？
- [ ] `window.__lastAIOutput` 中 AI 输出了什么？
- [ ] `window.__lastParsedCard` 的结构是否正确？
- [ ] 是否有 `restrictions` 对象？
- [ ] `icon` URL 是否正确？

根据以上信息可以快速定位问题所在！






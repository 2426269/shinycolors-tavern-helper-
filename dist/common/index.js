var e={976:(e,t,n)=>{n.d(t,{getGachaData:()=>d,saveGachaData:()=>u});const a='shinycolors_game_data',r=1,o={RESOURCES:'resources',GACHA:'gacha',SETTINGS:'settings',AFFECTION:'affection',METADATA:'metadata'};let s=null;async function i(){return s||new Promise((e,t)=>{const n=indexedDB.open(a,r);n.onerror=()=>{console.error('âŒ IndexedDBæ‰“å¼€å¤±è´¥:',n.error),t(n.error)},n.onsuccess=()=>{s=n.result,console.log('âœ… IndexedDBæ‰“å¼€æˆåŠŸ'),e(n.result)},n.onupgradeneeded=e=>{const t=e.target.result;Object.values(o).forEach(e=>{t.objectStoreNames.contains(e)||(t.createObjectStore(e),console.log(`ðŸ“¦ åˆ›å»ºå¯¹è±¡å­˜å‚¨: ${e}`))})}})}async function c(e,t){try{const n=await i();return new Promise((a,r)=>{const o=n.transaction(e,'readonly').objectStore(e).get(t);o.onsuccess=()=>a(o.result||null),o.onerror=()=>r(o.error)})}catch(n){return console.error(`âŒ è¯»å–æ•°æ®å¤±è´¥ [${e}/${t}]:`,n),null}}async function l(e,t,n){try{const a=await i(),r=JSON.parse(JSON.stringify(n));return new Promise((n,o)=>{const s=a.transaction(e,'readwrite').objectStore(e).put(r,t);s.onsuccess=()=>n(),s.onerror=()=>o(s.error)})}catch(n){throw console.error(`âŒ å†™å…¥æ•°æ®å¤±è´¥ [${e}/${t}]:`,n),n}}async function d(){return await c(o.GACHA,'main')||{stardust:0,ownedCards:{},pity:{totalPulls:0,ssrPity:0,urPity:0},history:[]}}async function u(e){await l(o.GACHA,'main',e)}}},t={};function n(a){var r=t[a];if(void 0!==r)return r.exports;var o=t[a]={exports:{}};return e[a](o,o.exports,n),o.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const a=new class{userMessageHandlers=new Set;aiMessageHandlers=new Set;generationHandlers=new Set;initialized=!1;initialize(){this.initialized?console.warn('âš ï¸ MessageInterceptor å·²ç»åˆå§‹åŒ–è¿‡äº†'):(console.log('ðŸŽ¯ åˆå§‹åŒ–æ¶ˆæ¯æ‹¦æˆªå™¨...'),'undefined'!=typeof eventOn?(this.initializeEventListeners(),this.initialized=!0,console.log('âœ… æ¶ˆæ¯æ‹¦æˆªå™¨åˆå§‹åŒ–å®Œæˆ')):console.error('âŒ eventOn å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åœ¨é…’é¦†çŽ¯å¢ƒä¸­è¿è¡Œ'))}initializeEventListeners(){eventOn(tavern_events.MESSAGE_SENT,e=>{this.handleUserMessage({type:'user',content:e.text||e.message||'',timestamp:Date.now(),metadata:{messageId:e.mesId}})}),eventOn(tavern_events.MESSAGE_RECEIVED,e=>{this.handleAIMessage({type:'ai',content:e.text||e.message||'',timestamp:Date.now(),metadata:{characterName:e.character_name,swipeId:e.swipe_id,messageId:e.mesId}})}),eventOn(tavern_events.GENERATION_STARTED,e=>{this.handleGenerationEvent({type:'started',timestamp:Date.now(),metadata:e})}),eventOn(tavern_events.GENERATION_STOPPED,e=>{this.handleGenerationEvent({type:'stopped',timestamp:Date.now(),metadata:e})}),console.log('ðŸ“¡ äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ')}handleUserMessage(e){console.log('ðŸ‘¤ [ç”¨æˆ·æ¶ˆæ¯]:',e.content.substring(0,100)),this.userMessageHandlers.forEach(t=>{try{t(e)}catch(e){console.error('âŒ ç”¨æˆ·æ¶ˆæ¯å¤„ç†å™¨é”™è¯¯:',e)}})}handleAIMessage(e){console.log('ðŸ¤– [AIæ¶ˆæ¯]:',e.content.substring(0,100)),this.aiMessageHandlers.forEach(t=>{try{t(e)}catch(e){console.error('âŒ AIæ¶ˆæ¯å¤„ç†å™¨é”™è¯¯:',e)}})}handleGenerationEvent(e){console.log('âš¡ [ç”Ÿæˆäº‹ä»¶]:',e.type),this.generationHandlers.forEach(t=>{try{t(e)}catch(e){console.error('âŒ ç”Ÿæˆäº‹ä»¶å¤„ç†å™¨é”™è¯¯:',e)}})}onUserMessage(e){return this.userMessageHandlers.add(e),()=>{this.userMessageHandlers.delete(e)}}onAIMessage(e){return this.aiMessageHandlers.add(e),()=>{this.aiMessageHandlers.delete(e)}}onGeneration(e){return this.generationHandlers.add(e),()=>{this.generationHandlers.delete(e)}}async injectText(e){try{await triggerSlash('/echo',e),console.log('âœ… æ–‡æœ¬å·²æ³¨å…¥')}catch(e){throw console.error('âŒ æ³¨å…¥æ–‡æœ¬å¤±è´¥:',e),e}}async appendToSystemPrompt(e){try{await triggerSlash('/setvar',`key=game_context ${e}`),console.log('âœ… ç³»ç»Ÿæç¤ºè¯å·²æ›´æ–°')}catch(e){throw console.error('âŒ æ›´æ–°ç³»ç»Ÿæç¤ºè¯å¤±è´¥:',e),e}}async triggerGeneration(e){try{e&&await this.injectText(e),await triggerSlash('/generate'),console.log('âœ… å·²è§¦å‘AIç”Ÿæˆ')}catch(e){throw console.error('âŒ è§¦å‘ç”Ÿæˆå¤±è´¥:',e),e}}getCurrentCharacter(){if('undefined'!=typeof SillyTavern&&SillyTavern.getContext){const e=SillyTavern.getContext();return{name:e.name1||'æœªçŸ¥',characterId:e.characterId,chatId:e.chatId}}return null}getCurrentChatId(){return'undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null}};function r(){const e=a.onUserMessage(e=>{console.log('æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯:',e.content),e.content.includes('ç”ŸæˆæŠ€èƒ½å¡')&&(console.log('ðŸŽ¨ æ£€æµ‹åˆ°ç”Ÿæˆè¯·æ±‚ï¼'),async function(e){const t=function(e){const t={};e.includes('ç†æ€§')&&(t.attribute='ç†æ€§');e.includes('æ„Ÿæ€§')&&(t.attribute='æ„Ÿæ€§');e.includes('éžå‡¡')&&(t.attribute='éžå‡¡');e.includes('è‡ªç”±')&&(t.attribute='è‡ªç”±');e.includes('SSR')&&(t.rarity='SSR');e.includes('SR')&&(t.rarity='SR');e.includes('R')&&(t.rarity='R');e.includes('N')&&(t.rarity='N');return t}(e.content),n=`\nè¯·ç”Ÿæˆä¸€å¼ æŠ€èƒ½å¡ï¼š\n- å±žæ€§ï¼š${t.attribute||'ç†æ€§'}\n- ç¨€æœ‰åº¦ï¼š${t.rarity||'SSR'}\n\nè¾“å‡ºæ ¼å¼ï¼š\n\`\`\`json\n{\n  "name": "å¡ç‰Œåç§°",\n  "attribute": "ç†æ€§",\n  "rarity": "SSR",\n  "cost": 5,\n  "effect_before": "æ•ˆæžœæè¿°",\n  "effect_after": "å¼ºåŒ–åŽæ•ˆæžœ"\n}\n\`\`\`\n  `;await a.appendToSystemPrompt(n),console.log('âœ… æç¤ºè¯å·²æ³¨å…¥')}(e)),e.content.includes('æŸ¥çœ‹å¡ç‰Œ')&&console.log('ðŸ“‹ æ˜¾ç¤ºå¡ç‰Œåˆ—è¡¨')});$(window).on('pagehide',e)}function o(){const e=a.onAIMessage(e=>{console.log('æ”¶åˆ°AIæ¶ˆæ¯:',e.content);const t=function(e){const t=e.match(/```json\s*([\s\S]*?)\s*```/);if(t)try{const e=JSON.parse(t[1]);if(e.name&&e.attribute)return e}catch(e){console.warn('JSONè§£æžå¤±è´¥:',e)}return null}(e.content);t&&(console.log('âœ… è§£æžåˆ°æŠ€èƒ½å¡:',t),async function(e){const{getGachaData:t,saveGachaData:a}=await Promise.resolve().then(n.bind(n,976)),r=await t();r.generatedSkillCards||(r.generatedSkillCards=[]);r.generatedSkillCards.push({...e,generatedAt:Date.now(),id:`generated_${Date.now()}`}),await a(r),console.log('ðŸ’¾ æŠ€èƒ½å¡å·²ä¿å­˜åˆ°IndexedDB')}(t),toastr.success(`æ–°æŠ€èƒ½å¡å·²ç”Ÿæˆï¼š${t.name}`))});$(window).on('pagehide',e)}function s(){r(),o(),function(){const e=a.onGeneration(e=>{'started'===e.type&&console.log('ðŸš€ AIå¼€å§‹ç”Ÿæˆ...'),'stopped'===e.type&&console.log('â¸ï¸ AIç”Ÿæˆå·²åœæ­¢'),'finished'===e.type&&console.log('âœ… AIç”Ÿæˆå®Œæˆ')});$(window).on('pagehide',e)}(),console.log('âœ… æ‰€æœ‰æ¶ˆæ¯ç›‘å¬å™¨å·²åˆå§‹åŒ–')}$(()=>{a.initialize()});export{s as initializeAllListeners,a as messageInterceptor};
//# sourceMappingURL=index.js.map
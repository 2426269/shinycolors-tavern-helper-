{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/game-data.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/common/message-interceptor.ts","src://tavern_helper_template/src/common/interceptor-example.ts"],"sourcesContent":["/**\n * IndexedDB æ¸¸æˆæ•°æ®ç®¡ç†ç³»ç»Ÿ\n *\n * åŠŸèƒ½ï¼š\n * - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼ˆèµ„æºã€æŠ½å¡ã€è®¾ç½®ç­‰ï¼‰\n * - æ”¯æŒä»localStorageè‡ªåŠ¨è¿ç§»\n * - æä¾›ç±»å‹å®‰å…¨çš„API\n * - é«˜æ€§èƒ½å¼‚æ­¥æ“ä½œ\n */\n\n// ============================================================================\n// ç±»å‹å®šä¹‰\n// ============================================================================\n\nexport interface GameResources {\n  featherStones: number; // ç¾½çŸ³\n  fans: number; // ç²‰ä¸\n  producerLevel: number; // åˆ¶ä½œäººç­‰çº§\n  producerExp: number; // ç»éªŒå€¼\n  producerName?: string; // åˆ¶ä½œäººåç§°\n}\n\nexport interface GachaData {\n  stardust: number; // æ˜Ÿå°˜\n  ownedCards: Record<string, any>; // æ‹¥æœ‰çš„å¡ç‰Œ {cardId: cardData}\n  pity: {\n    totalPulls: number;\n    ssrPity: number;\n    urPity: number;\n  };\n  history: Array<{\n    timestamp: number;\n    cards: string[];\n    type: 'single' | 'ten';\n  }>;\n}\n\nexport interface GameSettings {\n  fullscreenMode: 'button' | 'doubleclick' | 'both';\n  devMode: {\n    infiniteGems: boolean;\n    unlockAllCharacters: boolean;\n    maxLevel: boolean;\n  };\n  musicVolume: number;\n  autoPlay: boolean;\n  playMode: 'sequential' | 'random' | 'single';\n}\n\nexport interface AffectionData {\n  [idolId: string]: number; // å¶åƒID -> å¥½æ„Ÿåº¦å€¼\n}\n\n// ============================================================================\n// IndexedDB é…ç½®\n// ============================================================================\n\nconst DB_NAME = 'shinycolors_game_data';\nconst DB_VERSION = 1;\n\nconst STORES = {\n  RESOURCES: 'resources',\n  GACHA: 'gacha',\n  SETTINGS: 'settings',\n  AFFECTION: 'affection',\n  METADATA: 'metadata', // å­˜å‚¨è¿ç§»çŠ¶æ€ç­‰å…ƒæ•°æ®\n} as const;\n\n// ============================================================================\n// IndexedDB åˆå§‹åŒ–\n// ============================================================================\n\nlet dbInstance: IDBDatabase | null = null;\n\n/**\n * æ‰“å¼€æ•°æ®åº“\n */\nasync function openDatabase(): Promise<IDBDatabase> {\n  if (dbInstance) {\n    return dbInstance;\n  }\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n    request.onerror = () => {\n      console.error('âŒ IndexedDBæ‰“å¼€å¤±è´¥:', request.error);\n      reject(request.error);\n    };\n\n    request.onsuccess = () => {\n      dbInstance = request.result;\n      console.log('âœ… IndexedDBæ‰“å¼€æˆåŠŸ');\n      resolve(request.result);\n    };\n\n    request.onupgradeneeded = event => {\n      const db = (event.target as IDBOpenDBRequest).result;\n\n      // åˆ›å»ºæ‰€æœ‰å¯¹è±¡å­˜å‚¨\n      Object.values(STORES).forEach(storeName => {\n        if (!db.objectStoreNames.contains(storeName)) {\n          db.createObjectStore(storeName);\n          console.log(`ğŸ“¦ åˆ›å»ºå¯¹è±¡å­˜å‚¨: ${storeName}`);\n        }\n      });\n    };\n  });\n}\n\n// ============================================================================\n// é€šç”¨è¯»å†™æ“ä½œ\n// ============================================================================\n\n/**\n * ä»IndexedDBè¯»å–æ•°æ®\n */\nasync function getData<T>(storeName: string, key: string): Promise<T | null> {\n  try {\n    const db = await openDatabase();\n    return new Promise((resolve, reject) => {\n      const transaction = db.transaction(storeName, 'readonly');\n      const store = transaction.objectStore(storeName);\n      const request = store.get(key);\n\n      request.onsuccess = () => resolve(request.result || null);\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error(`âŒ è¯»å–æ•°æ®å¤±è´¥ [${storeName}/${key}]:`, error);\n    return null;\n  }\n}\n\n/**\n * å‘IndexedDBå†™å…¥æ•°æ®\n */\nasync function setData<T>(storeName: string, key: string, value: T): Promise<void> {\n  try {\n    const db = await openDatabase();\n\n    // æ·±æ‹·è´å»é™¤Proxyï¼ˆä½¿ç”¨JSONåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼‰\n    const cleanValue = JSON.parse(JSON.stringify(value));\n\n    return new Promise((resolve, reject) => {\n      const transaction = db.transaction(storeName, 'readwrite');\n      const store = transaction.objectStore(storeName);\n      const request = store.put(cleanValue, key);\n\n      request.onsuccess = () => resolve();\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error(`âŒ å†™å…¥æ•°æ®å¤±è´¥ [${storeName}/${key}]:`, error);\n    throw error;\n  }\n}\n\n/**\n * åˆ é™¤æ•°æ®\n */\nasync function deleteData(storeName: string, key: string): Promise<void> {\n  try {\n    const db = await openDatabase();\n    return new Promise((resolve, reject) => {\n      const transaction = db.transaction(storeName, 'readwrite');\n      const store = transaction.objectStore(storeName);\n      const request = store.delete(key);\n\n      request.onsuccess = () => resolve();\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error(`âŒ åˆ é™¤æ•°æ®å¤±è´¥ [${storeName}/${key}]:`, error);\n    throw error;\n  }\n}\n\n/**\n * æ¸…ç©ºæ•´ä¸ªå­˜å‚¨\n */\nasync function clearStore(storeName: string): Promise<void> {\n  try {\n    const db = await openDatabase();\n    return new Promise((resolve, reject) => {\n      const transaction = db.transaction(storeName, 'readwrite');\n      const store = transaction.objectStore(storeName);\n      const request = store.clear();\n\n      request.onsuccess = () => {\n        console.log(`ğŸ—‘ï¸ å·²æ¸…ç©ºå­˜å‚¨: ${storeName}`);\n        resolve();\n      };\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error(`âŒ æ¸…ç©ºå­˜å‚¨å¤±è´¥ [${storeName}]:`, error);\n    throw error;\n  }\n}\n\n// ============================================================================\n// localStorage è¿ç§»\n// ============================================================================\n\n/**\n * ä»localStorageè¿ç§»æ•°æ®åˆ°IndexedDB\n */\nexport async function migrateFromLocalStorage(): Promise<void> {\n  console.log('ğŸ”„ å¼€å§‹ä»localStorageè¿ç§»æ•°æ®...');\n\n  try {\n    // æ£€æŸ¥æ˜¯å¦å·²ç»è¿ç§»è¿‡\n    const migrated = await getData<boolean>(STORES.METADATA, 'migrated_from_localstorage');\n    if (migrated) {\n      console.log('âœ… æ•°æ®å·²ç»è¿ç§»è¿‡ï¼Œè·³è¿‡');\n      return;\n    }\n\n    // è¿ç§»èµ„æºæ•°æ®\n    const resourcesStr = localStorage.getItem('shinycolors_resources');\n    if (resourcesStr) {\n      try {\n        const resources = JSON.parse(resourcesStr);\n        await setData(STORES.RESOURCES, 'main', resources);\n        console.log('ğŸ“¦ è¿ç§»èµ„æºæ•°æ®æˆåŠŸ');\n      } catch (e) {\n        console.warn('âš ï¸ èµ„æºæ•°æ®è§£æå¤±è´¥:', e);\n      }\n    }\n\n    // è¿ç§»æŠ½å¡æ•°æ®\n    const gachaStr = localStorage.getItem('shinycolors_gacha_data');\n    if (gachaStr) {\n      try {\n        const gacha = JSON.parse(gachaStr);\n        await setData(STORES.GACHA, 'main', gacha);\n        console.log('ğŸ´ è¿ç§»æŠ½å¡æ•°æ®æˆåŠŸ');\n      } catch (e) {\n        console.warn('âš ï¸ æŠ½å¡æ•°æ®è§£æå¤±è´¥:', e);\n      }\n    }\n\n    // è¿ç§»è®¾ç½®æ•°æ®\n    const settingsStr = localStorage.getItem('shinycolors_settings');\n    if (settingsStr) {\n      try {\n        const settings = JSON.parse(settingsStr);\n        await setData(STORES.SETTINGS, 'main', settings);\n        console.log('âš™ï¸ è¿ç§»è®¾ç½®æ•°æ®æˆåŠŸ');\n      } catch (e) {\n        console.warn('âš ï¸ è®¾ç½®æ•°æ®è§£æå¤±è´¥:', e);\n      }\n    }\n\n    // è¿ç§»å¥½æ„Ÿåº¦æ•°æ®\n    const affectionStr = localStorage.getItem('shinycolors_affection');\n    if (affectionStr) {\n      try {\n        const affection = JSON.parse(affectionStr);\n        await setData(STORES.AFFECTION, 'main', affection);\n        console.log('ğŸ’– è¿ç§»å¥½æ„Ÿåº¦æ•°æ®æˆåŠŸ');\n      } catch (e) {\n        console.warn('âš ï¸ å¥½æ„Ÿåº¦æ•°æ®è§£æå¤±è´¥:', e);\n      }\n    }\n\n    // è¿ç§»åˆ¶ä½œäººåç§°\n    const producerName = localStorage.getItem('shinycolors_producer_name');\n    if (producerName) {\n      await setData(STORES.RESOURCES, 'producer_name', producerName);\n      console.log('ğŸ‘¤ è¿ç§»åˆ¶ä½œäººåç§°æˆåŠŸ');\n    }\n\n    // æ ‡è®°å·²è¿ç§»\n    await setData(STORES.METADATA, 'migrated_from_localstorage', true);\n    await setData(STORES.METADATA, 'migration_date', new Date().toISOString());\n\n    console.log('âœ… æ•°æ®è¿ç§»å®Œæˆï¼');\n    console.log('ğŸ’¡ æç¤ºï¼šå¯ä»¥æ‰‹åŠ¨æ¸…ç†localStorageä»¥é‡Šæ”¾ç©ºé—´');\n  } catch (error) {\n    console.error('âŒ æ•°æ®è¿ç§»å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n// ============================================================================\n// èµ„æºæ•°æ® API\n// ============================================================================\n\nexport async function getResources(): Promise<GameResources> {\n  const data = await getData<GameResources>(STORES.RESOURCES, 'main');\n  return (\n    data || {\n      featherStones: 3000,\n      fans: 0,\n      producerLevel: 1,\n      producerExp: 0,\n    }\n  );\n}\n\nexport async function saveResources(resources: GameResources): Promise<void> {\n  await setData(STORES.RESOURCES, 'main', resources);\n}\n\nexport async function getProducerName(): Promise<string> {\n  const name = await getData<string>(STORES.RESOURCES, 'producer_name');\n  return name || 'åˆ¶ä½œäºº';\n}\n\nexport async function saveProducerName(name: string): Promise<void> {\n  await setData(STORES.RESOURCES, 'producer_name', name);\n}\n\n// ============================================================================\n// æŠ½å¡æ•°æ® API\n// ============================================================================\n\nexport async function getGachaData(): Promise<GachaData> {\n  const data = await getData<GachaData>(STORES.GACHA, 'main');\n  return (\n    data || {\n      stardust: 0,\n      ownedCards: {},\n      pity: {\n        totalPulls: 0,\n        ssrPity: 0,\n        urPity: 0,\n      },\n      history: [],\n    }\n  );\n}\n\nexport async function saveGachaData(gacha: GachaData): Promise<void> {\n  await setData(STORES.GACHA, 'main', gacha);\n}\n\n// ============================================================================\n// è®¾ç½®æ•°æ® API\n// ============================================================================\n\nexport async function getSettings(): Promise<GameSettings> {\n  const data = await getData<GameSettings>(STORES.SETTINGS, 'main');\n  return (\n    data || {\n      fullscreenMode: 'button',\n      devMode: {\n        infiniteGems: false,\n        unlockAllCharacters: false,\n        maxLevel: false,\n      },\n      musicVolume: 0.7,\n      autoPlay: false,\n      playMode: 'sequential',\n    }\n  );\n}\n\nexport async function saveSettings(settings: GameSettings): Promise<void> {\n  await setData(STORES.SETTINGS, 'main', settings);\n}\n\n// ============================================================================\n// å¥½æ„Ÿåº¦æ•°æ® API\n// ============================================================================\n\nexport async function getAffection(): Promise<AffectionData> {\n  const data = await getData<AffectionData>(STORES.AFFECTION, 'main');\n  return data || {};\n}\n\nexport async function saveAffection(affection: AffectionData): Promise<void> {\n  await setData(STORES.AFFECTION, 'main', affection);\n}\n\n// ============================================================================\n// ç®¡ç†åŠŸèƒ½\n// ============================================================================\n\n/**\n * æ¸…é™¤æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼ˆä¿ç•™è¿ç§»æ ‡è®°ï¼‰\n */\nexport async function clearAllGameData(): Promise<void> {\n  console.log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¸¸æˆæ•°æ®...');\n\n  await clearStore(STORES.RESOURCES);\n  await clearStore(STORES.GACHA);\n  await clearStore(STORES.SETTINGS);\n  await clearStore(STORES.AFFECTION);\n\n  console.log('âœ… æ¸¸æˆæ•°æ®å·²æ¸…é™¤');\n}\n\n/**\n * æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬è¿ç§»æ ‡è®°ï¼‰\n */\nexport async function clearAllData(): Promise<void> {\n  console.log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ï¼‰...');\n\n  await clearAllGameData();\n  await clearStore(STORES.METADATA);\n\n  console.log('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');\n}\n\n/**\n * å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼ˆç”¨äºå¤‡ä»½ï¼‰\n */\nexport async function exportAllData(): Promise<string> {\n  const data = {\n    resources: await getResources(),\n    producerName: await getProducerName(),\n    gacha: await getGachaData(),\n    settings: await getSettings(),\n    affection: await getAffection(),\n    exportDate: new Date().toISOString(),\n  };\n\n  return JSON.stringify(data, null, 2);\n}\n\n/**\n * å¯¼å…¥æ•°æ®ï¼ˆä»å¤‡ä»½æ¢å¤ï¼‰\n */\nexport async function importAllData(jsonStr: string): Promise<void> {\n  try {\n    const data = JSON.parse(jsonStr);\n\n    if (data.resources) await saveResources(data.resources);\n    if (data.producerName) await saveProducerName(data.producerName);\n    if (data.gacha) await saveGachaData(data.gacha);\n    if (data.settings) await saveSettings(data.settings);\n    if (data.affection) await saveAffection(data.affection);\n\n    console.log('âœ… æ•°æ®å¯¼å…¥æˆåŠŸ');\n  } catch (error) {\n    console.error('âŒ æ•°æ®å¯¼å…¥å¤±è´¥:', error);\n    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');\n  }\n}\n\n// ============================================================================\n// åˆå§‹åŒ–\n// ============================================================================\n\n/**\n * åˆå§‹åŒ–æ¸¸æˆæ•°æ®ç³»ç»Ÿ\n */\nexport async function initGameData(): Promise<void> {\n  console.log('ğŸ® åˆå§‹åŒ–æ¸¸æˆæ•°æ®ç³»ç»Ÿ...');\n\n  // æ‰“å¼€æ•°æ®åº“\n  await openDatabase();\n\n  // è‡ªåŠ¨è¿ç§»localStorageæ•°æ®\n  await migrateFromLocalStorage();\n\n  console.log('âœ… æ¸¸æˆæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","/**\n * SillyTavern æ¶ˆæ¯æ‹¦æˆªå™¨\n *\n * åŠŸèƒ½ï¼š\n * - ç›‘å¬ç”¨æˆ·å‘é€çš„æ¶ˆæ¯\n * - ç›‘å¬AIç”Ÿæˆçš„å›å¤\n * - ç›‘å¬ç”Ÿæˆäº‹ä»¶ï¼ˆå¯æ³¨å…¥æç¤ºè¯ï¼‰\n * - æä¾›äº‹ä»¶è®¢é˜…æœºåˆ¶\n */\n\n// ============================================================================\n// ç±»å‹å®šä¹‰\n// ============================================================================\n\n/** æ‹¦æˆªåˆ°çš„æ¶ˆæ¯ */\nexport interface InterceptedMessage {\n  type: 'user' | 'ai';\n  content: string;\n  timestamp: number;\n  metadata?: {\n    characterName?: string;\n    swipeId?: number;\n    messageId?: number;\n  };\n}\n\n/** ç”Ÿæˆäº‹ä»¶æ•°æ® */\nexport interface GenerationEvent {\n  type: 'started' | 'stopped' | 'finished';\n  timestamp: number;\n  metadata?: any;\n}\n\n/** æ¶ˆæ¯å¤„ç†å™¨ */\ntype MessageHandler = (message: InterceptedMessage) => void | Promise<void>;\ntype GenerationHandler = (event: GenerationEvent) => void | Promise<void>;\n\n// ============================================================================\n// æ¶ˆæ¯æ‹¦æˆªå™¨ç±»\n// ============================================================================\n\nclass MessageInterceptor {\n  // ç”¨æˆ·æ¶ˆæ¯å¤„ç†å™¨é›†åˆ\n  private userMessageHandlers = new Set<MessageHandler>();\n\n  // AIæ¶ˆæ¯å¤„ç†å™¨é›†åˆ\n  private aiMessageHandlers = new Set<MessageHandler>();\n\n  // ç”Ÿæˆäº‹ä»¶å¤„ç†å™¨é›†åˆ\n  private generationHandlers = new Set<GenerationHandler>();\n\n  // æ˜¯å¦å·²åˆå§‹åŒ–\n  private initialized = false;\n\n  /**\n   * åˆå§‹åŒ–æ‹¦æˆªå™¨ï¼ˆç›‘å¬é…’é¦†äº‹ä»¶ï¼‰\n   */\n  initialize(): void {\n    if (this.initialized) {\n      console.warn('âš ï¸ MessageInterceptor å·²ç»åˆå§‹åŒ–è¿‡äº†');\n      return;\n    }\n\n    console.log('ğŸ¯ åˆå§‹åŒ–æ¶ˆæ¯æ‹¦æˆªå™¨...');\n\n    // æ£€æŸ¥é…’é¦†åŠ©æ‰‹æ˜¯å¦å¯ç”¨\n    if (typeof eventOn === 'undefined') {\n      console.error('âŒ eventOn å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åœ¨é…’é¦†ç¯å¢ƒä¸­è¿è¡Œ');\n      return;\n    }\n\n    this.initializeEventListeners();\n    this.initialized = true;\n\n    console.log('âœ… æ¶ˆæ¯æ‹¦æˆªå™¨åˆå§‹åŒ–å®Œæˆ');\n  }\n\n  /**\n   * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨\n   */\n  private initializeEventListeners(): void {\n    // ç›‘å¬ç”¨æˆ·å‘é€æ¶ˆæ¯\n    eventOn(tavern_events.MESSAGE_SENT, (data: any) => {\n      this.handleUserMessage({\n        type: 'user',\n        content: data.text || data.message || '',\n        timestamp: Date.now(),\n        metadata: {\n          messageId: data.mesId,\n        },\n      });\n    });\n\n    // ç›‘å¬AIå›å¤æ¶ˆæ¯\n    eventOn(tavern_events.MESSAGE_RECEIVED, (data: any) => {\n      this.handleAIMessage({\n        type: 'ai',\n        content: data.text || data.message || '',\n        timestamp: Date.now(),\n        metadata: {\n          characterName: data.character_name,\n          swipeId: data.swipe_id,\n          messageId: data.mesId,\n        },\n      });\n    });\n\n    // ç›‘å¬ç”Ÿæˆå¼€å§‹\n    eventOn(tavern_events.GENERATION_STARTED, (data: any) => {\n      this.handleGenerationEvent({\n        type: 'started',\n        timestamp: Date.now(),\n        metadata: data,\n      });\n    });\n\n    // ç›‘å¬ç”Ÿæˆç»“æŸ\n    eventOn(tavern_events.GENERATION_STOPPED, (data: any) => {\n      this.handleGenerationEvent({\n        type: 'stopped',\n        timestamp: Date.now(),\n        metadata: data,\n      });\n    });\n\n    console.log('ğŸ“¡ äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ');\n  }\n\n  /**\n   * å¤„ç†ç”¨æˆ·æ¶ˆæ¯\n   */\n  private handleUserMessage(message: InterceptedMessage): void {\n    console.log('ğŸ‘¤ [ç”¨æˆ·æ¶ˆæ¯]:', message.content.substring(0, 100));\n\n    // é€šçŸ¥æ‰€æœ‰å¤„ç†å™¨\n    this.userMessageHandlers.forEach(handler => {\n      try {\n        handler(message);\n      } catch (error) {\n        console.error('âŒ ç”¨æˆ·æ¶ˆæ¯å¤„ç†å™¨é”™è¯¯:', error);\n      }\n    });\n  }\n\n  /**\n   * å¤„ç†AIæ¶ˆæ¯\n   */\n  private handleAIMessage(message: InterceptedMessage): void {\n    console.log('ğŸ¤– [AIæ¶ˆæ¯]:', message.content.substring(0, 100));\n\n    // é€šçŸ¥æ‰€æœ‰å¤„ç†å™¨\n    this.aiMessageHandlers.forEach(handler => {\n      try {\n        handler(message);\n      } catch (error) {\n        console.error('âŒ AIæ¶ˆæ¯å¤„ç†å™¨é”™è¯¯:', error);\n      }\n    });\n  }\n\n  /**\n   * å¤„ç†ç”Ÿæˆäº‹ä»¶\n   */\n  private handleGenerationEvent(event: GenerationEvent): void {\n    console.log('âš¡ [ç”Ÿæˆäº‹ä»¶]:', event.type);\n\n    // é€šçŸ¥æ‰€æœ‰å¤„ç†å™¨\n    this.generationHandlers.forEach(handler => {\n      try {\n        handler(event);\n      } catch (error) {\n        console.error('âŒ ç”Ÿæˆäº‹ä»¶å¤„ç†å™¨é”™è¯¯:', error);\n      }\n    });\n  }\n\n  // ==========================================================================\n  // å…¬å…±API - è®¢é˜…äº‹ä»¶\n  // ==========================================================================\n\n  /**\n   * è®¢é˜…ç”¨æˆ·æ¶ˆæ¯\n   * @returns å–æ¶ˆè®¢é˜…å‡½æ•°\n   */\n  onUserMessage(handler: MessageHandler): () => void {\n    this.userMessageHandlers.add(handler);\n    return () => {\n      this.userMessageHandlers.delete(handler);\n    };\n  }\n\n  /**\n   * è®¢é˜…AIæ¶ˆæ¯\n   * @returns å–æ¶ˆè®¢é˜…å‡½æ•°\n   */\n  onAIMessage(handler: MessageHandler): () => void {\n    this.aiMessageHandlers.add(handler);\n    return () => {\n      this.aiMessageHandlers.delete(handler);\n    };\n  }\n\n  /**\n   * è®¢é˜…ç”Ÿæˆäº‹ä»¶\n   * @returns å–æ¶ˆè®¢é˜…å‡½æ•°\n   */\n  onGeneration(handler: GenerationHandler): () => void {\n    this.generationHandlers.add(handler);\n    return () => {\n      this.generationHandlers.delete(handler);\n    };\n  }\n\n  // ==========================================================================\n  // å…¬å…±API - å‘é…’é¦†å‘é€æŒ‡ä»¤\n  // ==========================================================================\n\n  /**\n   * æ³¨å…¥æ–‡æœ¬åˆ°å½“å‰å¯¹è¯ï¼ˆä¸ä¼šå‘é€ç»™LLMï¼Œä»…æ˜¾ç¤ºåœ¨UIï¼‰\n   */\n  async injectText(text: string): Promise<void> {\n    try {\n      // ä½¿ç”¨é…’é¦†åŠ©æ‰‹çš„slashå‘½ä»¤\n      await triggerSlash('/echo', text);\n      console.log('âœ… æ–‡æœ¬å·²æ³¨å…¥');\n    } catch (error) {\n      console.error('âŒ æ³¨å…¥æ–‡æœ¬å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è¿½åŠ å†…å®¹åˆ°ç³»ç»Ÿæç¤ºè¯ï¼ˆä¼šå½±å“LLMï¼‰\n   */\n  async appendToSystemPrompt(content: string): Promise<void> {\n    try {\n      // ä½¿ç”¨é…’é¦†çš„setvarå‘½ä»¤è®¾ç½®ä¸´æ—¶å˜é‡\n      await triggerSlash('/setvar', `key=game_context ${content}`);\n      console.log('âœ… ç³»ç»Ÿæç¤ºè¯å·²æ›´æ–°');\n    } catch (error) {\n      console.error('âŒ æ›´æ–°ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è§¦å‘ä¸€æ¬¡AIç”Ÿæˆ\n   */\n  async triggerGeneration(prompt?: string): Promise<void> {\n    try {\n      if (prompt) {\n        // å…ˆæ³¨å…¥æç¤ºè¯\n        await this.injectText(prompt);\n      }\n\n      // è§¦å‘ç”Ÿæˆ\n      await triggerSlash('/generate');\n      console.log('âœ… å·²è§¦å‘AIç”Ÿæˆ');\n    } catch (error) {\n      console.error('âŒ è§¦å‘ç”Ÿæˆå¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è·å–å½“å‰è§’è‰²å¡ä¿¡æ¯\n   */\n  getCurrentCharacter(): any {\n    if (typeof SillyTavern !== 'undefined' && SillyTavern.getContext) {\n      const context = SillyTavern.getContext();\n      return {\n        name: context.name1 || 'æœªçŸ¥',\n        characterId: context.characterId,\n        chatId: context.chatId,\n      };\n    }\n    return null;\n  }\n\n  /**\n   * è·å–å½“å‰èŠå¤©ID\n   */\n  getCurrentChatId(): string | null {\n    if (typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId) {\n      return SillyTavern.getCurrentChatId();\n    }\n    return null;\n  }\n}\n\n// ============================================================================\n// å¯¼å‡ºå•ä¾‹\n// ============================================================================\n\nexport const messageInterceptor = new MessageInterceptor();\n\n// è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶ï¼‰\n$(() => {\n  messageInterceptor.initialize();\n});\n","/**\n * æ¶ˆæ¯æ‹¦æˆªå™¨ä½¿ç”¨ç¤ºä¾‹\n *\n * å±•ç¤ºå¦‚ä½•ä½¿ç”¨ messageInterceptor ç›‘å¬å’Œå“åº”æ¶ˆæ¯\n */\n\nimport { messageInterceptor, type InterceptedMessage } from './message-interceptor';\n\n// ============================================================================\n// ç¤ºä¾‹ 1: ç›‘å¬ç”¨æˆ·æ¶ˆæ¯\n// ============================================================================\n\nexport function setupUserMessageListener() {\n  const unsubscribe = messageInterceptor.onUserMessage((message: InterceptedMessage) => {\n    console.log('æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯:', message.content);\n\n    // æ£€æµ‹ç‰¹å®šå…³é”®è¯\n    if (message.content.includes('ç”ŸæˆæŠ€èƒ½å¡')) {\n      console.log('ğŸ¨ æ£€æµ‹åˆ°ç”Ÿæˆè¯·æ±‚ï¼');\n      handleSkillCardGenerationRequest(message);\n    }\n\n    if (message.content.includes('æŸ¥çœ‹å¡ç‰Œ')) {\n      console.log('ğŸ“‹ æ˜¾ç¤ºå¡ç‰Œåˆ—è¡¨');\n      // TODO: æ‰“å¼€å¡ç‰Œç®¡ç†ç•Œé¢\n    }\n  });\n\n  // åœ¨é¡µé¢å¸è½½æ—¶å–æ¶ˆè®¢é˜…\n  $(window).on('pagehide', unsubscribe);\n}\n\n// ============================================================================\n// ç¤ºä¾‹ 2: ç›‘å¬AIå›å¤\n// ============================================================================\n\nexport function setupAIMessageListener() {\n  const unsubscribe = messageInterceptor.onAIMessage((message: InterceptedMessage) => {\n    console.log('æ”¶åˆ°AIæ¶ˆæ¯:', message.content);\n\n    // å°è¯•è§£æç»“æ„åŒ–å†…å®¹\n    const parsed = parseSkillCardFromAI(message.content);\n\n    if (parsed) {\n      console.log('âœ… è§£æåˆ°æŠ€èƒ½å¡:', parsed);\n      saveGeneratedSkillCard(parsed);\n      toastr.success(`æ–°æŠ€èƒ½å¡å·²ç”Ÿæˆï¼š${parsed.name}`);\n    }\n  });\n\n  $(window).on('pagehide', unsubscribe);\n}\n\n// ============================================================================\n// ç¤ºä¾‹ 3: ç›‘å¬ç”Ÿæˆäº‹ä»¶\n// ============================================================================\n\nexport function setupGenerationListener() {\n  const unsubscribe = messageInterceptor.onGeneration(event => {\n    if (event.type === 'started') {\n      console.log('ğŸš€ AIå¼€å§‹ç”Ÿæˆ...');\n      // å¯ä»¥åœ¨è¿™é‡Œæ³¨å…¥é¢å¤–çš„ä¸Šä¸‹æ–‡\n    }\n\n    if (event.type === 'stopped') {\n      console.log('â¸ï¸ AIç”Ÿæˆå·²åœæ­¢');\n    }\n\n    if (event.type === 'finished') {\n      console.log('âœ… AIç”Ÿæˆå®Œæˆ');\n    }\n  });\n\n  $(window).on('pagehide', unsubscribe);\n}\n\n// ============================================================================\n// è¾…åŠ©å‡½æ•°\n// ============================================================================\n\n/**\n * å¤„ç†æŠ€èƒ½å¡ç”Ÿæˆè¯·æ±‚\n */\nasync function handleSkillCardGenerationRequest(message: InterceptedMessage) {\n  // æå–å‚æ•°\n  const params = extractGenerationParams(message.content);\n\n  // ç»„è£…æç¤ºè¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå®Œæ•´ç‰ˆåœ¨ prompt-factory.tsï¼‰\n  const prompt = `\nè¯·ç”Ÿæˆä¸€å¼ æŠ€èƒ½å¡ï¼š\n- å±æ€§ï¼š${params.attribute || 'ç†æ€§'}\n- ç¨€æœ‰åº¦ï¼š${params.rarity || 'SSR'}\n\nè¾“å‡ºæ ¼å¼ï¼š\n\\`\\`\\`json\n{\n  \"name\": \"å¡ç‰Œåç§°\",\n  \"attribute\": \"ç†æ€§\",\n  \"rarity\": \"SSR\",\n  \"cost\": 5,\n  \"effect_before\": \"æ•ˆæœæè¿°\",\n  \"effect_after\": \"å¼ºåŒ–åæ•ˆæœ\"\n}\n\\`\\`\\`\n  `;\n\n  // æ³¨å…¥æç¤ºè¯\n  await messageInterceptor.appendToSystemPrompt(prompt);\n\n  console.log('âœ… æç¤ºè¯å·²æ³¨å…¥');\n}\n\n/**\n * æå–ç”Ÿæˆå‚æ•°\n */\nfunction extractGenerationParams(content: string): {\n  attribute?: string;\n  rarity?: string;\n} {\n  const params: any = {};\n\n  // æ£€æµ‹å±æ€§\n  if (content.includes('ç†æ€§')) params.attribute = 'ç†æ€§';\n  if (content.includes('æ„Ÿæ€§')) params.attribute = 'æ„Ÿæ€§';\n  if (content.includes('éå‡¡')) params.attribute = 'éå‡¡';\n  if (content.includes('è‡ªç”±')) params.attribute = 'è‡ªç”±';\n\n  // æ£€æµ‹ç¨€æœ‰åº¦\n  if (content.includes('SSR')) params.rarity = 'SSR';\n  if (content.includes('SR')) params.rarity = 'SR';\n  if (content.includes('R')) params.rarity = 'R';\n  if (content.includes('N')) params.rarity = 'N';\n\n  return params;\n}\n\n/**\n * ä»AIå›å¤ä¸­è§£ææŠ€èƒ½å¡\n */\nfunction parseSkillCardFromAI(content: string): any {\n  // å°è¯•è§£æJSONä»£ç å—\n  const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n  if (jsonMatch) {\n    try {\n      const parsed = JSON.parse(jsonMatch[1]);\n      if (parsed.name && parsed.attribute) {\n        return parsed;\n      }\n    } catch (e) {\n      console.warn('JSONè§£æå¤±è´¥:', e);\n    }\n  }\n\n  return null;\n}\n\n/**\n * ä¿å­˜AIç”Ÿæˆçš„æŠ€èƒ½å¡\n */\nasync function saveGeneratedSkillCard(card: any) {\n  // å¯¼å…¥å­˜å‚¨å‡½æ•°\n  const { getGachaData, saveGachaData } = await import('../å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/game-data');\n\n  // è¯»å–ç°æœ‰æ•°æ®\n  const gameData = await getGachaData();\n\n  // æ·»åŠ ç”Ÿæˆçš„æŠ€èƒ½å¡\n  if (!gameData.generatedSkillCards) {\n    (gameData as any).generatedSkillCards = [];\n  }\n\n  (gameData as any).generatedSkillCards.push({\n    ...card,\n    generatedAt: Date.now(),\n    id: `generated_${Date.now()}`,\n  });\n\n  // ä¿å­˜\n  await saveGachaData(gameData);\n\n  console.log('ğŸ’¾ æŠ€èƒ½å¡å·²ä¿å­˜åˆ°IndexedDB');\n}\n\n// ============================================================================\n// åˆå§‹åŒ–æ‰€æœ‰ç›‘å¬å™¨\n// ============================================================================\n\nexport function initializeAllListeners() {\n  setupUserMessageListener();\n  setupAIMessageListener();\n  setupGenerationListener();\n\n  console.log('âœ… æ‰€æœ‰æ¶ˆæ¯ç›‘å¬å™¨å·²åˆå§‹åŒ–');\n}\n"],"names":["STORES","RESOURCES","GACHA","SETTINGS","AFFECTION","METADATA","dbInstance","async","openDatabase","Promise","resolve","reject","request","indexedDB","open","onerror","console","error","onsuccess","result","log","onupgradeneeded","event","db","target","Object","values","forEach","storeName","objectStoreNames","contains","createObjectStore","getData","key","transaction","objectStore","get","setData","value","cleanValue","JSON","parse","stringify","put","getGachaData","stardust","ownedCards","pity","totalPulls","ssrPity","urPity","history","saveGachaData","gacha","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","d","definition","o","defineProperty","enumerable","obj","prop","prototype","hasOwnProperty","call","messageInterceptor","userMessageHandlers","Set","aiMessageHandlers","generationHandlers","initialized","initialize","this","warn","eventOn","initializeEventListeners","tavern_events","MESSAGE_SENT","data","handleUserMessage","type","content","text","message","timestamp","Date","now","metadata","messageId","mesId","MESSAGE_RECEIVED","handleAIMessage","characterName","character_name","swipeId","swipe_id","GENERATION_STARTED","handleGenerationEvent","GENERATION_STOPPED","substring","handler","onUserMessage","add","delete","onAIMessage","onGeneration","injectText","triggerSlash","appendToSystemPrompt","triggerGeneration","prompt","getCurrentCharacter","SillyTavern","getContext","context","name","name1","characterId","chatId","getCurrentChatId","setupUserMessageListener","unsubscribe","includes","params","attribute","rarity","extractGenerationParams","handleSkillCardGenerationRequest","$","window","on","setupAIMessageListener","parsed","jsonMatch","match","e","parseSkillCardFromAI","card","gameData","generatedSkillCards","push","generatedAt","id","saveGeneratedSkillCard","toastr","success","initializeAllListeners","setupGenerationListener"],"ignoreList":[],"sourceRoot":""}
{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/utils/event-bus.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/core/attribute-manager.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/core/buff-manager.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/core/resource-manager.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/presets/buff-presets.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/core/skill-card-executor.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/core/battle-controller.ts","src://tavern_helper_template/src/偶像大师闪耀色彩-cardgame/data/skill-card-parser.ts"],"sourcesContent":["/**\r\n * 事件总线\r\n *\r\n * 用于游戏系统内部的事件通信\r\n */\r\n\r\ntype EventCallback = (...args: any[]) => void;\r\n\r\nclass EventBusClass {\r\n  private events: Map<string, EventCallback[]> = new Map();\r\n\r\n  /**\r\n   * 监听事件\r\n   */\r\n  on(event: string, callback: EventCallback): void {\r\n    if (!this.events.has(event)) {\r\n      this.events.set(event, []);\r\n    }\r\n    this.events.get(event)!.push(callback);\r\n  }\r\n\r\n  /**\r\n   * 移除事件监听\r\n   */\r\n  off(event: string, callback: EventCallback): void {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n\r\n    const index = callbacks.indexOf(callback);\r\n    if (index !== -1) {\r\n      callbacks.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 触发事件\r\n   */\r\n  emit(event: string, ...args: any[]): void {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n\r\n    for (const callback of callbacks) {\r\n      try {\r\n        callback(...args);\r\n      } catch (error) {\r\n        console.error(`[EventBus] Error in ${event} handler:`, error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 只监听一次\r\n   */\r\n  once(event: string, callback: EventCallback): void {\r\n    const onceCallback: EventCallback = (...args: any[]) => {\r\n      callback(...args);\r\n      this.off(event, onceCallback);\r\n    };\r\n    this.on(event, onceCallback);\r\n  }\r\n\r\n  /**\r\n   * 清除所有监听器\r\n   */\r\n  clear(): void {\r\n    this.events.clear();\r\n  }\r\n\r\n  /**\r\n   * 清除指定事件的所有监听器\r\n   */\r\n  clearEvent(event: string): void {\r\n    this.events.delete(event);\r\n  }\r\n}\r\n\r\n/**\r\n * 全局事件总线实例\r\n */\r\nexport const EventBus = new EventBusClass();\r\n\r\n/**\r\n * 游戏事件类型定义\r\n */\r\nexport const GameEvents = {\r\n  // 属性变化\r\n  ATTRIBUTE_CHANGED: 'attribute_changed',\r\n  ALL_POWER_FULL: 'all_power_full',\r\n\r\n  // 资源变化\r\n  STAMINA_CHANGED: 'stamina_changed',\r\n  GENKI_CHANGED: 'genki_changed',\r\n\r\n  // Buff变化\r\n  BUFF_ADDED: 'buff_added',\r\n  BUFF_REMOVED: 'buff_removed',\r\n  BUFF_UPDATED: 'buff_updated',\r\n\r\n  // 得分变化\r\n  SCORE_CHANGED: 'score_changed',\r\n\r\n  // 卡牌操作\r\n  CARD_USED: 'card_used',\r\n  CARD_DRAWN: 'card_drawn',\r\n  CARD_DISCARDED: 'card_discarded',\r\n  CARD_REMOVED: 'card_removed',\r\n\r\n  // 回合变化\r\n  TURN_STARTED: 'turn_started',\r\n  TURN_ENDED: 'turn_ended',\r\n\r\n  // 战斗状态\r\n  BATTLE_STARTED: 'battle_started',\r\n  BATTLE_ENDED: 'battle_ended',\r\n\r\n  // 非凡系统\r\n  ANOMALY_STATE_CHANGED: 'anomaly_state_changed',\r\n  POINTER_LOCKED: 'pointer_locked',\r\n  POINTER_UNLOCKED: 'pointer_unlocked',\r\n} as const;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * 属性管理器\r\n *\r\n * 管理游戏中的所有属性（专注、干劲、好印象、全力值、热意值等）\r\n */\r\n\r\nimport type { BattleAttributes, BattleState } from '../types';\r\nimport { EventBus, GameEvents } from '../utils/event-bus';\r\n\r\nexport class AttributeManager {\r\n  private state: BattleState;\r\n\r\n  constructor(state: BattleState) {\r\n    this.state = state;\r\n  }\r\n\r\n  /**\r\n   * 增加属性值\r\n   *\r\n   * @param attributeName 属性名称\r\n   * @param value 增加的值\r\n   */\r\n  add(attributeName: keyof BattleAttributes, value: number): void {\r\n    if (value <= 0) return;\r\n\r\n    const current = this.state.attributes[attributeName] as number;\r\n    const newValue = current + value;\r\n\r\n    // 更新属性\r\n    (this.state.attributes[attributeName] as number) = newValue;\r\n\r\n    // 触发事件\r\n    this.onAttributeChanged(attributeName, value);\r\n  }\r\n\r\n  /**\r\n   * 消耗属性值\r\n   *\r\n   * @param attributeName 属性名称\r\n   * @param value 消耗的值\r\n   * @returns 是否成功消耗\r\n   */\r\n  consume(attributeName: keyof BattleAttributes, value: number): boolean {\r\n    if (value <= 0) return true;\r\n\r\n    const current = this.state.attributes[attributeName] as number;\r\n\r\n    // 检查是否足够\r\n    if (current < value) {\r\n      return false; // 资源不足\r\n    }\r\n\r\n    // 消耗属性\r\n    (this.state.attributes[attributeName] as number) = current - value;\r\n\r\n    // 触发事件\r\n    this.onAttributeChanged(attributeName, -value);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 获取属性值\r\n   *\r\n   * @param attributeName 属性名称\r\n   * @returns 属性值\r\n   */\r\n  get(attributeName: keyof BattleAttributes): number {\r\n    const value = this.state.attributes[attributeName];\r\n\r\n    // 处理特殊类型\r\n    if (typeof value === 'number') {\r\n      return value;\r\n    }\r\n\r\n    // anomalyState、stateLevel、pointerLocked等非数字类型返回0\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * 设置属性值\r\n   *\r\n   * @param attributeName 属性名称\r\n   * @param value 新值\r\n   */\r\n  set(attributeName: keyof BattleAttributes, value: number): void {\r\n    const oldValue = this.get(attributeName);\r\n    (this.state.attributes[attributeName] as number) = Math.max(0, value);\r\n\r\n    const delta = value - oldValue;\r\n    if (delta !== 0) {\r\n      this.onAttributeChanged(attributeName, delta);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 属性变化回调\r\n   *\r\n   * @param attributeName 属性名称\r\n   * @param delta 变化量\r\n   */\r\n  private onAttributeChanged(attributeName: string, delta: number): void {\r\n    // 触发通用属性变化事件\r\n    EventBus.emit(GameEvents.ATTRIBUTE_CHANGED, {\r\n      attributeName,\r\n      delta,\r\n      newValue: this.get(attributeName as keyof BattleAttributes),\r\n    });\r\n\r\n    // 特殊处理：全力值满10\r\n    if (attributeName === 'allPower') {\r\n      const allPower = this.get('allPower');\r\n      if (allPower >= 10) {\r\n        this.triggerAllPowerTransform();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 全力值转化（非凡系统）\r\n   *\r\n   * 当全力值达到10时，转化为全力状态\r\n   */\r\n  private triggerAllPowerTransform(): void {\r\n    // 消耗10全力值\r\n    this.state.attributes.allPower = 0;\r\n\r\n    // 切换到全力状态\r\n    this.state.attributes.anomalyState = 'allout';\r\n    this.state.attributes.stateLevel = 1;\r\n\r\n    // 触发事件（BuffManager会监听此事件并添加全力状态Buff）\r\n    EventBus.emit(GameEvents.ALL_POWER_FULL, {\r\n      planType: this.state.planType,\r\n    });\r\n\r\n    // 触发非凡状态变化事件\r\n    EventBus.emit(GameEvents.ANOMALY_STATE_CHANGED, {\r\n      oldState: null,\r\n      newState: 'allout',\r\n      level: 1,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 切换非凡状态\r\n   *\r\n   * @param newState 新状态\r\n   * @param level 状态阶段（1或2）\r\n   */\r\n  switchAnomalyState(newState: 'allout' | 'conserve' | 'resolute' | 'relaxed', level: 1 | 2 = 1): void {\r\n    const oldState = this.state.attributes.anomalyState;\r\n\r\n    // 更新状态\r\n    this.state.attributes.anomalyState = newState;\r\n    this.state.attributes.stateLevel = level;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.ANOMALY_STATE_CHANGED, {\r\n      oldState,\r\n      newState,\r\n      level,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 清除非凡状态\r\n   */\r\n  clearAnomalyState(): void {\r\n    const oldState = this.state.attributes.anomalyState;\r\n\r\n    if (oldState) {\r\n      this.state.attributes.anomalyState = null;\r\n      this.state.attributes.stateLevel = 1;\r\n\r\n      EventBus.emit(GameEvents.ANOMALY_STATE_CHANGED, {\r\n        oldState,\r\n        newState: null,\r\n        level: 1,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 锁定非凡指针\r\n   */\r\n  lockPointer(): void {\r\n    if (!this.state.attributes.pointerLocked) {\r\n      this.state.attributes.pointerLocked = true;\r\n      EventBus.emit(GameEvents.POINTER_LOCKED);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解锁非凡指针\r\n   */\r\n  unlockPointer(): void {\r\n    if (this.state.attributes.pointerLocked) {\r\n      this.state.attributes.pointerLocked = false;\r\n      EventBus.emit(GameEvents.POINTER_UNLOCKED);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重置所有属性\r\n   */\r\n  reset(): void {\r\n    this.state.attributes = {\r\n      concentration: 0,\r\n      motivation: 0,\r\n      goodImpression: 0,\r\n      allPower: 0,\r\n      heat: 0,\r\n      anomalyState: null,\r\n      stateLevel: 1,\r\n      pointerLocked: false,\r\n      energy: 0,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 获取所有属性的快照\r\n   */\r\n  snapshot(): BattleAttributes {\r\n    return { ...this.state.attributes };\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * Buff管理器\r\n *\r\n * 管理游戏中的所有Buff/Debuff\r\n */\r\n\r\nimport type { BattleState, Buff, BuffEffectContext, BuffTrigger } from '../types';\r\nimport { EventBus, GameEvents } from '../utils/event-bus';\r\n\r\nexport class BuffManager {\r\n  /**\r\n   * 添加Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buff Buff数据\r\n   */\r\n  static addBuff(state: BattleState, buff: Buff): void {\r\n    const existing = state.buffs.get(buff.id);\r\n\r\n    if (existing) {\r\n      // 已存在同类Buff\r\n      if (this.isStackableBuff(buff.type)) {\r\n        // 可叠加型：增加层数\r\n        existing.stacks += buff.stacks;\r\n      } else {\r\n        // 刷新型：重置持续时间\r\n        existing.duration = buff.duration;\r\n      }\r\n\r\n      // 触发Buff更新事件\r\n      EventBus.emit(GameEvents.BUFF_UPDATED, {\r\n        buff: existing,\r\n      });\r\n    } else {\r\n      // 新Buff\r\n      state.buffs.set(buff.id, buff);\r\n\r\n      // 触发Buff添加事件\r\n      EventBus.emit(GameEvents.BUFF_ADDED, {\r\n        buff,\r\n      });\r\n    }\r\n\r\n    // 触发Buff获得时的效果\r\n    this.triggerBuffEffects(state, buff, 'buff_gained');\r\n  }\r\n\r\n  /**\r\n   * 移除Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffId Buff ID\r\n   */\r\n  static removeBuff(state: BattleState, buffId: string): void {\r\n    const buff = state.buffs.get(buffId);\r\n    if (!buff) return;\r\n\r\n    // 移除Buff\r\n    state.buffs.delete(buffId);\r\n\r\n    // 触发Buff失去时的效果\r\n    this.triggerBuffEffects(state, buff, 'buff_lost');\r\n\r\n    // 触发Buff移除事件\r\n    EventBus.emit(GameEvents.BUFF_REMOVED, {\r\n      buff,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 消耗Buff（减少层数或回合数）\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffId Buff ID\r\n   * @param amount 消耗量\r\n   * @returns 是否成功消耗\r\n   */\r\n  static consumeBuff(state: BattleState, buffId: string, amount: number = 1): boolean {\r\n    const buff = state.buffs.get(buffId);\r\n    if (!buff) return false;\r\n\r\n    if (buff.stacks > 0) {\r\n      // 减少层数\r\n      buff.stacks -= amount;\r\n      if (buff.stacks <= 0) {\r\n        this.removeBuff(state, buffId);\r\n      } else {\r\n        EventBus.emit(GameEvents.BUFF_UPDATED, { buff });\r\n      }\r\n      return true;\r\n    } else if (buff.duration > 0) {\r\n      // 减少回合数\r\n      buff.duration -= amount;\r\n      if (buff.duration <= 0) {\r\n        this.removeBuff(state, buffId);\r\n      } else {\r\n        EventBus.emit(GameEvents.BUFF_UPDATED, { buff });\r\n      }\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * 回合开始时更新Buff\r\n   *\r\n   * @param state 战斗状态\r\n   */\r\n  static updateBuffsOnTurnStart(state: BattleState): void {\r\n    const buffsToRemove: string[] = [];\r\n\r\n    for (const [buffId, buff] of state.buffs.entries()) {\r\n      // 触发回合开始效果\r\n      this.triggerBuffEffects(state, buff, 'turn_start');\r\n\r\n      // 减少持续时间（仅针对duration > 0的Buff）\r\n      if (buff.duration > 0) {\r\n        buff.duration--;\r\n        if (buff.duration === 0) {\r\n          buffsToRemove.push(buffId);\r\n        } else {\r\n          EventBus.emit(GameEvents.BUFF_UPDATED, { buff });\r\n        }\r\n      }\r\n    }\r\n\r\n    // 移除过期的Buff\r\n    for (const buffId of buffsToRemove) {\r\n      this.removeBuff(state, buffId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 回合结束时更新Buff\r\n   *\r\n   * @param state 战斗状态\r\n   */\r\n  static updateBuffsOnTurnEnd(state: BattleState): void {\r\n    for (const buff of state.buffs.values()) {\r\n      // 触发回合结束效果（如好印象）\r\n      this.triggerBuffEffects(state, buff, 'turn_end');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 触发Buff效果\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buff Buff数据\r\n   * @param trigger 触发时机\r\n   * @param context 上下文（可选）\r\n   */\r\n  static triggerBuffEffects(state: BattleState, buff: Buff, trigger: BuffTrigger, context?: BuffEffectContext): void {\r\n    for (const buffEffect of buff.effects) {\r\n      if (buffEffect.trigger === trigger) {\r\n        try {\r\n          buffEffect.effect(state, context);\r\n        } catch (error) {\r\n          console.error(`[BuffManager] Error executing ${buff.name} effect:`, error);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取Buff效果值（用于查询）\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffType Buff类型\r\n   * @returns 效果值（层数或1）\r\n   */\r\n  static getBuffEffect(state: BattleState, buffType: string): number {\r\n    let total = 0;\r\n\r\n    for (const buff of state.buffs.values()) {\r\n      if (buff.type === buffType) {\r\n        total += buff.stacks || 1;\r\n      }\r\n    }\r\n\r\n    return total;\r\n  }\r\n\r\n  /**\r\n   * 检查是否有Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffType Buff类型\r\n   * @returns 是否存在\r\n   */\r\n  static hasBuff(state: BattleState, buffType: string): boolean {\r\n    for (const buff of state.buffs.values()) {\r\n      if (buff.type === buffType) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * 获取Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffId Buff ID\r\n   * @returns Buff数据\r\n   */\r\n  static getBuff(state: BattleState, buffId: string): Buff | undefined {\r\n    return state.buffs.get(buffId);\r\n  }\r\n\r\n  /**\r\n   * 获取所有正面Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns Buff列表\r\n   */\r\n  static getPositiveBuffs(state: BattleState): Buff[] {\r\n    return Array.from(state.buffs.values()).filter(buff => buff.category === 'positive');\r\n  }\r\n\r\n  /**\r\n   * 获取所有负面Buff\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns Buff列表\r\n   */\r\n  static getNegativeBuffs(state: BattleState): Buff[] {\r\n    return Array.from(state.buffs.values()).filter(buff => buff.category === 'negative');\r\n  }\r\n\r\n  /**\r\n   * 清除所有负面Buff\r\n   *\r\n   * @param state 战斗状态\r\n   */\r\n  static clearNegativeBuffs(state: BattleState): void {\r\n    const negativeBuffs = this.getNegativeBuffs(state);\r\n    for (const buff of negativeBuffs) {\r\n      this.removeBuff(state, buff.id);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清除所有Buff\r\n   *\r\n   * @param state 战斗状态\r\n   */\r\n  static clearAllBuffs(state: BattleState): void {\r\n    const allBuffIds = Array.from(state.buffs.keys());\r\n    for (const buffId of allBuffIds) {\r\n      this.removeBuff(state, buffId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 延长Buff持续时间\r\n   *\r\n   * @param state 战斗状态\r\n   * @param buffId Buff ID\r\n   * @param turns 延长的回合数\r\n   */\r\n  static extendBuffDuration(state: BattleState, buffId: string, turns: number): void {\r\n    const buff = state.buffs.get(buffId);\r\n    if (!buff || buff.duration <= 0) return;\r\n\r\n    buff.duration += turns;\r\n    EventBus.emit(GameEvents.BUFF_UPDATED, { buff });\r\n  }\r\n\r\n  /**\r\n   * 判断Buff类型是否可叠加\r\n   *\r\n   * @param buffType Buff类型\r\n   * @returns 是否可叠加\r\n   */\r\n  private static isStackableBuff(buffType: string): boolean {\r\n    // 可叠加的Buff类型\r\n    const stackableTypes = ['concentration', 'good_impression'];\r\n    return stackableTypes.includes(buffType);\r\n  }\r\n\r\n  /**\r\n   * 获取Buff总数\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns Buff数量\r\n   */\r\n  static getBuffCount(state: BattleState): number {\r\n    return state.buffs.size;\r\n  }\r\n\r\n  /**\r\n   * 获取所有Buff的快照\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns Buff列表\r\n   */\r\n  static snapshot(state: BattleState): Buff[] {\r\n    return Array.from(state.buffs.values()).map(buff => ({ ...buff }));\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * 资源管理器\r\n *\r\n * 管理游戏中的资源（体力、元气）\r\n */\r\n\r\nimport type { BattleState } from '../types';\r\nimport { EventBus, GameEvents } from '../utils/event-bus';\r\n\r\nexport class ResourceManager {\r\n  /**\r\n   * 回复体力\r\n   *\r\n   * @param state 战斗状态\r\n   * @param amount 回复量\r\n   * @returns 实际回复量\r\n   */\r\n  static recoverStamina(state: BattleState, amount: number): number {\r\n    if (amount <= 0) return 0;\r\n\r\n    const oldStamina = state.stamina;\r\n    state.stamina = Math.min(state.maxStamina, state.stamina + amount);\r\n    const actualRecovered = state.stamina - oldStamina;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.STAMINA_CHANGED, {\r\n      delta: actualRecovered,\r\n      current: state.stamina,\r\n      max: state.maxStamina,\r\n    });\r\n\r\n    return actualRecovered;\r\n  }\r\n\r\n  /**\r\n   * 消耗体力\r\n   *\r\n   * @param state 战斗状态\r\n   * @param amount 消耗量\r\n   * @returns 是否成功消耗\r\n   */\r\n  static consumeStamina(state: BattleState, amount: number): boolean {\r\n    if (amount <= 0) return true;\r\n\r\n    // 检查体力消耗减少Buff\r\n    const reduction = this.getStaminaReduction(state);\r\n    const actualCost = Math.max(0, amount - reduction);\r\n\r\n    // 检查是否足够\r\n    if (state.stamina < actualCost) {\r\n      return false; // 体力不足\r\n    }\r\n\r\n    // 消耗体力\r\n    state.stamina -= actualCost;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.STAMINA_CHANGED, {\r\n      delta: -actualCost,\r\n      current: state.stamina,\r\n      max: state.maxStamina,\r\n    });\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 增加元气\r\n   *\r\n   * @param state 战斗状态\r\n   * @param amount 增加量\r\n   * @returns 实际增加量\r\n   */\r\n  static gainGenki(state: BattleState, amount: number): number {\r\n    if (amount <= 0) return 0;\r\n\r\n    // 检查元气增加Buff\r\n    const boost = this.getGenkiBoost(state);\r\n    const boostPercentage = boost * 0.01; // 转换为百分比\r\n    const actualGain = Math.floor(amount * (1 + boostPercentage));\r\n\r\n    const oldGenki = state.genki;\r\n    state.genki = Math.min(100, state.genki + actualGain);\r\n    const actualAdded = state.genki - oldGenki;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.GENKI_CHANGED, {\r\n      delta: actualAdded,\r\n      current: state.genki,\r\n      max: 100,\r\n    });\r\n\r\n    return actualAdded;\r\n  }\r\n\r\n  /**\r\n   * 消耗元气\r\n   *\r\n   * @param state 战斗状态\r\n   * @param amount 消耗量\r\n   * @returns 是否成功消耗\r\n   */\r\n  static consumeGenki(state: BattleState, amount: number): boolean {\r\n    if (amount <= 0) return true;\r\n\r\n    // 检查是否足够\r\n    if (state.genki < amount) {\r\n      return false; // 元气不足\r\n    }\r\n\r\n    // 消耗元气\r\n    state.genki -= amount;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.GENKI_CHANGED, {\r\n      delta: -amount,\r\n      current: state.genki,\r\n      max: 100,\r\n    });\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 获取体力消耗减少值\r\n   *\r\n   * 遍历所有Buff，累加体力消耗减少效果\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns 减少值\r\n   */\r\n  private static getStaminaReduction(state: BattleState): number {\r\n    let reduction = 0;\r\n\r\n    for (const buff of state.buffs.values()) {\r\n      if (buff.type === 'stamina_reduction') {\r\n        reduction += buff.stacks || 1;\r\n      }\r\n    }\r\n\r\n    return reduction;\r\n  }\r\n\r\n  /**\r\n   * 获取元气获取增加值（百分比）\r\n   *\r\n   * 遍历所有Buff，累加元气获取增加效果\r\n   *\r\n   * @param state 战斗状态\r\n   * @returns 增加百分比（如30表示+30%）\r\n   */\r\n  private static getGenkiBoost(state: BattleState): number {\r\n    let boost = 0;\r\n\r\n    for (const buff of state.buffs.values()) {\r\n      if (buff.type === 'genki_boost') {\r\n        boost += 30; // 默认+30%\r\n      } else if (buff.type === 'motivated') {\r\n        // \"有干劲\"Buff：元气获取量增加\r\n        boost += 30;\r\n      }\r\n    }\r\n\r\n    return boost;\r\n  }\r\n\r\n  /**\r\n   * 设置体力\r\n   *\r\n   * @param state 战斗状态\r\n   * @param value 新值\r\n   */\r\n  static setStamina(state: BattleState, value: number): void {\r\n    const oldValue = state.stamina;\r\n    state.stamina = Math.max(0, Math.min(state.maxStamina, value));\r\n\r\n    const delta = state.stamina - oldValue;\r\n    if (delta !== 0) {\r\n      EventBus.emit(GameEvents.STAMINA_CHANGED, {\r\n        delta,\r\n        current: state.stamina,\r\n        max: state.maxStamina,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置元气\r\n   *\r\n   * @param state 战斗状态\r\n   * @param value 新值\r\n   */\r\n  static setGenki(state: BattleState, value: number): void {\r\n    const oldValue = state.genki;\r\n    state.genki = Math.max(0, Math.min(100, value));\r\n\r\n    const delta = state.genki - oldValue;\r\n    if (delta !== 0) {\r\n      EventBus.emit(GameEvents.GENKI_CHANGED, {\r\n        delta,\r\n        current: state.genki,\r\n        max: 100,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 增加最大体力\r\n   *\r\n   * @param state 战斗状态\r\n   * @param amount 增加量\r\n   */\r\n  static increaseMaxStamina(state: BattleState, amount: number): void {\r\n    if (amount <= 0) return;\r\n\r\n    state.maxStamina += amount;\r\n\r\n    // 触发事件\r\n    EventBus.emit(GameEvents.STAMINA_CHANGED, {\r\n      delta: 0,\r\n      current: state.stamina,\r\n      max: state.maxStamina,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 检查是否有足够的资源\r\n   *\r\n   * @param state 战斗状态\r\n   * @param staminaCost 体力消耗\r\n   * @param genkiCost 元气消耗\r\n   * @returns 是否足够\r\n   */\r\n  static hasEnoughResources(state: BattleState, staminaCost: number, genkiCost: number): boolean {\r\n    // 应用体力消耗减少\r\n    const reduction = this.getStaminaReduction(state);\r\n    const actualStaminaCost = Math.max(0, staminaCost - reduction);\r\n\r\n    return state.stamina >= actualStaminaCost && state.genki >= genkiCost;\r\n  }\r\n\r\n  /**\r\n   * 获取资源状态快照\r\n   *\r\n   * @param state 战斗状态\r\n   */\r\n  static snapshot(state: BattleState): {\r\n    stamina: number;\r\n    maxStamina: number;\r\n    genki: number;\r\n  } {\r\n    return {\r\n      stamina: state.stamina,\r\n      maxStamina: state.maxStamina,\r\n      genki: state.genki,\r\n    };\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\n * Buff预设库\n *\n * 包含所有常用Buff的工厂函数\n */\n\nimport type { Buff } from '../types';\nimport { EventBus, GameEvents } from '../utils/event-bus';\n\n/**\n * Buff预设对象\n */\nexport const BuffPresets = {\n  // ========== 感性系统 ==========\n\n  /**\n   * 好調（得分+50%）\n   */\n  好調: (duration: number = 3): Buff => ({\n    id: 'good_condition',\n    name: '好調',\n    type: 'good_condition',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          // 得分+50% (在计分时应用)\n          state.score.current = Math.floor(state.score.current * 1.5);\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/好调.png',\n    color: '#4CAF50',\n  }),\n\n  /**\n   * 集中（每层+15分）\n   */\n  集中: (stacks: number = 1): Buff => ({\n    id: 'concentration',\n    name: '集中',\n    type: 'concentration',\n    category: 'positive',\n    stacks: stacks,\n    duration: -1, // 永久（直到消耗）\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          const buff = state.buffs.get('concentration');\n          if (buff) {\n            const bonus = buff.stacks * 15;\n            state.score.current += bonus;\n          }\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/集中.png',\n    color: '#2196F3',\n  }),\n\n  /**\n   * 絶好調（强化好調）\n   */\n  絶好調: (duration: number = 3): Buff => ({\n    id: 'excellent_condition',\n    name: '絶好調',\n    type: 'excellent_condition',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          // 得分+100%\n          state.score.current = Math.floor(state.score.current * 2);\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/好调.png', // 使用好调图标\n    color: '#FF9800',\n  }),\n\n  /**\n   * 状态良好\n   */\n  状态良好: (duration: number = 2): Buff => ({\n    id: 'state_good',\n    name: '状态良好',\n    type: 'state_good',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          // 得分+20%\n          state.score.current = Math.floor(state.score.current * 1.2);\n        },\n      },\n    ],\n    color: '#8BC34A',\n  }),\n\n  /**\n   * 状态绝佳\n   */\n  状态绝佳: (duration: number = 3): Buff => ({\n    id: 'great_condition',\n    name: '状态绝佳',\n    type: 'great_condition',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          // 得分+80%\n          state.score.current = Math.floor(state.score.current * 1.8);\n        },\n      },\n    ],\n    color: '#FFC107',\n  }),\n\n  // ========== 理性系统 ==========\n\n  /**\n   * 好印象（回合结束直接得分）\n   */\n  好印象: (stacks: number = 1): Buff => ({\n    id: 'good_impression',\n    name: '好印象',\n    type: 'good_impression',\n    category: 'positive',\n    stacks: stacks,\n    duration: -1, // 永久（直到消耗）\n    effects: [\n      {\n        trigger: 'turn_end',\n        effect: state => {\n          const buff = state.buffs.get('good_impression');\n          if (buff) {\n            const score = buff.stacks * 10; // 每层回合结束获得10分\n            state.score.current += score;\n            EventBus.emit(GameEvents.SCORE_CHANGED, {\n              delta: score,\n              source: 'good_impression',\n            });\n          }\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/好印象.png',\n    color: '#9C27B0',\n  }),\n\n  /**\n   * 有干劲（元气获取量+30%）\n   */\n  有干劲: (duration: number = 3): Buff => ({\n    id: 'motivated',\n    name: '有干劲',\n    type: 'motivated',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [],\n    // 效果在ResourceManager中处理\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/干劲.png',\n    color: '#F44336',\n  }),\n\n  // ========== 非凡系统 ==========\n\n  /**\n   * 全力状态（得分+200%）\n   */\n  全力状态: (level: 1 | 2 = 1): Buff => ({\n    id: `allout_state_${level}`,\n    name: `全力状态（${level === 1 ? '一阶段' : '二阶段'}）`,\n    type: level === 1 ? 'allout_state' : 'allout_state_2',\n    category: 'positive',\n    stacks: level,\n    duration: 3,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          if (level === 1) {\n            state.score.current = Math.floor(state.score.current * 3); // 得分+200%\n          } else {\n            state.score.current = Math.floor(state.score.current * 4); // 得分+300%\n          }\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/全力.png',\n    color: '#E91E63',\n  }),\n\n  /**\n   * 温存状态\n   */\n  温存状态: (level: 1 | 2 = 1): Buff => ({\n    id: `conserve_state_${level}`,\n    name: `温存状态（${level === 1 ? '一阶段' : '二阶段'}）`,\n    type: level === 1 ? 'conserve_state' : 'conserve_state_2',\n    category: 'positive',\n    stacks: level,\n    duration: 3,\n    effects: [\n      {\n        trigger: 'turn_end',\n        effect: state => {\n          // 回合结束获得热意值\n          const heatGain = level === 1 ? 2 : 3;\n          state.attributes.heat += heatGain;\n        },\n      },\n    ],\n    color: '#00BCD4',\n  }),\n\n  /**\n   * 强气状态（強気）\n   */\n  强气状态: (level: 1 | 2 = 1): Buff => ({\n    id: `resolute_state_${level}`,\n    name: `强气状态（${level === 1 ? '一阶段' : '二阶段'}）`,\n    type: level === 1 ? 'resolute_state' : 'resolute_state_2',\n    category: 'positive',\n    stacks: level,\n    duration: 3,\n    effects: [\n      {\n        trigger: 'card_used',\n        effect: state => {\n          // 使用卡牌时获得额外全力值\n          const allPowerGain = level === 1 ? 1 : 2;\n          state.attributes.allPower += allPowerGain;\n        },\n      },\n    ],\n    iconUrl: 'https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/游戏图标/强气.png',\n    color: '#FF5722',\n  }),\n\n  // ========== 通用正面Buff ==========\n\n  /**\n   * 体力消耗减少\n   */\n  体力消耗减少: (reduction: number = 1, duration: number = 3): Buff => ({\n    id: 'stamina_reduction',\n    name: `体力消耗-${reduction}`,\n    type: 'stamina_reduction',\n    category: 'positive',\n    stacks: reduction,\n    duration: duration,\n    effects: [],\n    // 效果在ResourceManager中处理\n    color: '#4CAF50',\n  }),\n\n  /**\n   * 元气获取增加\n   */\n  元气获取增加: (duration: number = 3): Buff => ({\n    id: 'genki_boost',\n    name: '元气获取+30%',\n    type: 'genki_boost',\n    category: 'positive',\n    stacks: 0,\n    duration: duration,\n    effects: [],\n    // 效果在ResourceManager中处理\n    color: '#FFEB3B',\n  }),\n\n  /**\n   * 得分增加\n   */\n  得分增加: (percentage: number = 20, duration: number = 3): Buff => ({\n    id: 'score_boost',\n    name: `得分+${percentage}%`,\n    type: 'score_boost',\n    category: 'positive',\n    stacks: percentage,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          const buff = state.buffs.get('score_boost');\n          if (buff) {\n            const multiplier = 1 + buff.stacks / 100;\n            state.score.current = Math.floor(state.score.current * multiplier);\n          }\n        },\n      },\n    ],\n    color: '#FFC107',\n  }),\n\n  /**\n   * 下一张卡效果×2\n   */\n  下一张卡效果x2: (): Buff => ({\n    id: 'double_effect',\n    name: '下一张卡效果×2',\n    type: 'double_effect',\n    category: 'positive',\n    stacks: 1,\n    duration: 1,\n    effects: [],\n    // 效果在SkillCardExecutor中处理\n    color: '#9C27B0',\n  }),\n\n  // ========== 负面Buff（Debuff） ==========\n\n  /**\n   * 疲劳（得分-20%）\n   */\n  疲劳: (duration: number = 2): Buff => ({\n    id: 'tired',\n    name: '疲劳',\n    type: 'tired',\n    category: 'negative',\n    stacks: 0,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'score_calculated',\n        effect: state => {\n          state.score.current = Math.floor(state.score.current * 0.8);\n        },\n      },\n    ],\n    color: '#757575',\n  }),\n\n  /**\n   * 体力流失（回合开始-5体力）\n   */\n  体力流失: (duration: number = 3): Buff => ({\n    id: 'stamina_drain',\n    name: '体力流失',\n    type: 'stamina_drain',\n    category: 'negative',\n    stacks: 5,\n    duration: duration,\n    effects: [\n      {\n        trigger: 'turn_start',\n        effect: state => {\n          const buff = state.buffs.get('stamina_drain');\n          if (buff) {\n            state.stamina = Math.max(0, state.stamina - buff.stacks);\n            EventBus.emit(GameEvents.STAMINA_CHANGED, {\n              delta: -buff.stacks,\n              current: state.stamina,\n              max: state.maxStamina,\n            });\n          }\n        },\n      },\n    ],\n    color: '#F44336',\n  }),\n};\n\n/**\n * 根据Buff类型创建Buff\n *\n * @param buffType Buff类型名称\n * @param params 参数（如duration、stacks等）\n * @returns Buff对象\n */\nexport function createBuff(buffType: keyof typeof BuffPresets, ...params: any[]): Buff | null {\n  const factory = BuffPresets[buffType];\n  if (!factory) {\n    console.error(`[BuffPresets] Unknown buff type: ${buffType}`);\n    return null;\n  }\n\n  try {\n    return factory(...params);\n  } catch (error) {\n    console.error(`[BuffPresets] Error creating buff ${buffType}:`, error);\n    return null;\n  }\n}\n","/**\r\n * 技能卡效果执行引擎\r\n *\r\n * 负责解析和执行技能卡的所有效果\r\n */\r\n\r\nimport { BuffPresets } from '../presets/buff-presets';\r\nimport type { BattleState, EffectCondition, EffectExecutionResult, SkillCard, SkillCardEffect } from '../types';\r\nimport { EventBus, GameEvents } from '../utils/event-bus';\r\nimport { AttributeManager } from './attribute-manager';\r\nimport { BuffManager } from './buff-manager';\r\nimport { ResourceManager } from './resource-manager';\r\n\r\nexport class SkillCardExecutor {\r\n  private state: BattleState;\r\n  private attributeManager: AttributeManager;\r\n\r\n  constructor(state: BattleState) {\r\n    this.state = state;\r\n    this.attributeManager = new AttributeManager(state);\r\n  }\r\n\r\n  /**\r\n   * 执行技能卡\r\n   *\r\n   * @param card 技能卡\r\n   * @returns 执行结果\r\n   */\r\n  async executeCard(card: SkillCard): Promise<EffectExecutionResult> {\r\n    const result: EffectExecutionResult = {\r\n      success: false,\r\n      changes: {},\r\n    };\r\n\r\n    try {\r\n      // 1. 检查是否可用\r\n      if (!this.canUseCard(card)) {\r\n        result.message = '无法使用该卡牌';\r\n        return result;\r\n      }\r\n\r\n      // 2. 消耗资源（元气/体力）\r\n      if (!this.consumeCardCost(card)) {\r\n        result.message = '资源不足';\r\n        return result;\r\n      }\r\n\r\n      // 3. 检查是否有\"下一张卡效果×2\" Buff\r\n      const hasDoubleEffect = BuffManager.hasBuff(this.state, 'double_effect');\r\n      const effectMultiplier = hasDoubleEffect ? 2 : 1;\r\n\r\n      // 4. 执行所有效果\r\n      for (let i = 0; i < effectMultiplier; i++) {\r\n        for (const effect of card.effects) {\r\n          const effectResult = await this.executeEffect(effect, card);\r\n          this.mergeResults(result, effectResult);\r\n        }\r\n      }\r\n\r\n      // 5. 消耗\"下一张卡效果×2\" Buff\r\n      if (hasDoubleEffect) {\r\n        BuffManager.consumeBuff(this.state, 'double_effect');\r\n      }\r\n\r\n      // 6. 触发卡牌使用事件\r\n      EventBus.emit(GameEvents.CARD_USED, {\r\n        card,\r\n        result,\r\n      });\r\n\r\n      // 7. 触发所有Buff的\"使用卡牌时\"效果\r\n      for (const buff of this.state.buffs.values()) {\r\n        BuffManager.triggerBuffEffects(this.state, buff, 'card_used', { card });\r\n      }\r\n\r\n      result.success = true;\r\n      return result;\r\n    } catch (error) {\r\n      console.error('[SkillCardExecutor] Error executing card:', error);\r\n      result.message = `执行失败: ${error}`;\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 执行单个效果\r\n   *\r\n   * @param effect 效果数据\r\n   * @param card 技能卡（用于上下文）\r\n   * @returns 执行结果\r\n   */\r\n  private async executeEffect(effect: SkillCardEffect, card: SkillCard): Promise<EffectExecutionResult> {\r\n    const result: EffectExecutionResult = {\r\n      success: true,\r\n      changes: {},\r\n    };\r\n\r\n    try {\r\n      switch (effect.type) {\r\n        case 'score_multiplier':\r\n          this.executeScoreMultiplier(effect, result);\r\n          break;\r\n\r\n        case 'gain_stamina':\r\n          this.executeGainStamina(effect, result);\r\n          break;\r\n\r\n        case 'gain_genki':\r\n          this.executeGainGenki(effect, result);\r\n          break;\r\n\r\n        case 'add_buff':\r\n          this.executeAddBuff(effect, result);\r\n          break;\r\n\r\n        case 'draw_cards':\r\n          this.executeDrawCards(effect, result);\r\n          break;\r\n\r\n        case 'extra_card_use':\r\n          this.executeExtraCardUse(effect, result);\r\n          break;\r\n\r\n        case 'extra_turn':\r\n          this.executeExtraTurn(effect, result);\r\n          break;\r\n\r\n        case 'gain_all_power':\r\n          this.executeGainAllPower(effect, result);\r\n          break;\r\n\r\n        case 'gain_heat':\r\n          this.executeGainHeat(effect, result);\r\n          break;\r\n\r\n        case 'change_anomaly_state':\r\n          this.executeChangeAnomalyState(effect, result);\r\n          break;\r\n\r\n        case 'lock_pointer':\r\n          this.executeLockPointer(effect, result);\r\n          break;\r\n\r\n        case 'consume_stamina':\r\n          this.executeConsumeStamina(effect, result);\r\n          break;\r\n\r\n        case 'consume_concentration':\r\n          this.executeConsumeConcentration(effect, result);\r\n          break;\r\n\r\n        case 'consume_motivation':\r\n          this.executeConsumeMotivation(effect, result);\r\n          break;\r\n\r\n        case 'consume_all_power':\r\n          this.executeConsumeAllPower(effect, result);\r\n          break;\r\n\r\n        case 'consume_buff':\r\n          this.executeConsumeBuff(effect, result);\r\n          break;\r\n\r\n        case 'amplify_score':\r\n          this.executeAmplifyScore(effect, result);\r\n          break;\r\n\r\n        case 'amplify_good_impression':\r\n          this.executeAmplifyGoodImpression(effect, result);\r\n          break;\r\n\r\n        case 'conditional_effect':\r\n          await this.executeConditionalEffect(effect, card, result);\r\n          break;\r\n\r\n        case 'chain_effect':\r\n          await this.executeChainEffect(effect, card, result);\r\n          break;\r\n\r\n        case 'special_effect':\r\n          this.executeSpecialEffect(effect, result);\r\n          break;\r\n\r\n        default:\r\n          console.warn(`[SkillCardExecutor] Unknown effect type: ${effect.type}`);\r\n      }\r\n    } catch (error) {\r\n      console.error(`[SkillCardExecutor] Error executing effect ${effect.type}:`, error);\r\n      result.success = false;\r\n      result.message = `效果执行失败: ${error}`;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // ========== 效果执行方法 ==========\r\n\r\n  /**\r\n   * 得分乘区（根据V/D/V属性）\r\n   */\r\n  private executeScoreMultiplier(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const { attribute, multiplier } = effect.metadata as any;\r\n    const attrValue = this.state.stats[attribute as 'vocal' | 'dance' | 'visual'];\r\n    const score = Math.floor(attrValue * multiplier);\r\n\r\n    this.state.score.current += score;\r\n    result.changes!.score = (result.changes!.score || 0) + score;\r\n\r\n    EventBus.emit(GameEvents.SCORE_CHANGED, {\r\n      delta: score,\r\n      source: 'skill_card',\r\n      attribute,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获得体力\r\n   */\r\n  private executeGainStamina(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const recovered = ResourceManager.recoverStamina(this.state, amount);\r\n    result.changes!.stamina = (result.changes!.stamina || 0) + recovered;\r\n  }\r\n\r\n  /**\r\n   * 获得元气\r\n   */\r\n  private executeGainGenki(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const gained = ResourceManager.gainGenki(this.state, amount);\r\n    result.changes!.genki = (result.changes!.genki || 0) + gained;\r\n  }\r\n\r\n  /**\r\n   * 添加Buff\r\n   */\r\n  private executeAddBuff(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const { type, stacks, duration } = effect.metadata as any;\r\n\r\n    // 从预设库创建Buff\r\n    let buff = null;\r\n    if (type in BuffPresets) {\r\n      buff = (BuffPresets as any)[type](stacks || duration);\r\n    }\r\n\r\n    if (buff) {\r\n      BuffManager.addBuff(this.state, buff);\r\n      result.changes!.buffsAdded = result.changes!.buffsAdded || [];\r\n      result.changes!.buffsAdded.push({ type, stacks: buff.stacks });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 抽牌\r\n   */\r\n  private executeDrawCards(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 1;\r\n    let drawn = 0;\r\n\r\n    for (let i = 0; i < amount; i++) {\r\n      if (this.state.hand.length >= 5) break; // 手牌上限5张\r\n      if (this.state.deck.length === 0) break; // 牌堆为空\r\n\r\n      const card = this.state.deck.shift()!;\r\n      this.state.hand.push(card);\r\n      drawn++;\r\n\r\n      EventBus.emit(GameEvents.CARD_DRAWN, { card });\r\n    }\r\n\r\n    result.changes!.cardsDrawn = drawn;\r\n  }\r\n\r\n  /**\r\n   * 额外技能卡使用次数\r\n   */\r\n  private executeExtraCardUse(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 1;\r\n    this.state.turnState.maxCardsPerTurn += amount;\r\n  }\r\n\r\n  /**\r\n   * 额外回合\r\n   */\r\n  private executeExtraTurn(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 1;\r\n    this.state.maxTurns += amount;\r\n  }\r\n\r\n  /**\r\n   * 获得全力值\r\n   */\r\n  private executeGainAllPower(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 1;\r\n    this.attributeManager.add('allPower', amount);\r\n  }\r\n\r\n  /**\r\n   * 获得热意值\r\n   */\r\n  private executeGainHeat(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 1;\r\n    this.attributeManager.add('heat', amount);\r\n  }\r\n\r\n  /**\r\n   * 切换非凡状态\r\n   */\r\n  private executeChangeAnomalyState(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const { newState, level } = effect.metadata as any;\r\n    this.attributeManager.switchAnomalyState(newState, level || 1);\r\n  }\r\n\r\n  /**\r\n   * 锁定指针\r\n   */\r\n  private executeLockPointer(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    this.attributeManager.lockPointer();\r\n  }\r\n\r\n  /**\r\n   * 消耗体力\r\n   */\r\n  private executeConsumeStamina(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const success = ResourceManager.consumeStamina(this.state, amount);\r\n    if (!success) {\r\n      result.success = false;\r\n      result.message = '体力不足';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 消耗专注\r\n   */\r\n  private executeConsumeConcentration(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const success = this.attributeManager.consume('concentration', amount);\r\n    if (!success) {\r\n      result.success = false;\r\n      result.message = '专注不足';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 消耗干劲\r\n   */\r\n  private executeConsumeMotivation(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const success = this.attributeManager.consume('motivation', amount);\r\n    if (!success) {\r\n      result.success = false;\r\n      result.message = '干劲不足';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 消耗全力值\r\n   */\r\n  private executeConsumeAllPower(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const amount = effect.value || 0;\r\n    const success = this.attributeManager.consume('allPower', amount);\r\n    if (!success) {\r\n      result.success = false;\r\n      result.message = '全力值不足';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 消耗Buff\r\n   */\r\n  private executeConsumeBuff(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const { buffType, amount } = effect.metadata as any;\r\n    let consumed = 0;\r\n\r\n    for (const buff of this.state.buffs.values()) {\r\n      if (buff.type === buffType) {\r\n        const success = BuffManager.consumeBuff(this.state, buff.id, amount || 1);\r\n        if (success) consumed++;\r\n      }\r\n    }\r\n\r\n    result.changes!.buffsRemoved = result.changes!.buffsRemoved || [];\r\n    result.changes!.buffsRemoved.push({ type: buffType, stacks: consumed });\r\n  }\r\n\r\n  /**\r\n   * 放大得分\r\n   */\r\n  private executeAmplifyScore(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const multiplier = effect.value || 1;\r\n    const oldScore = this.state.score.current;\r\n    this.state.score.current = Math.floor(oldScore * multiplier);\r\n    const delta = this.state.score.current - oldScore;\r\n\r\n    result.changes!.score = (result.changes!.score || 0) + delta;\r\n\r\n    EventBus.emit(GameEvents.SCORE_CHANGED, {\r\n      delta,\r\n      source: 'amplify_score',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 放大好印象\r\n   */\r\n  private executeAmplifyGoodImpression(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    const multiplier = effect.value || 2;\r\n\r\n    for (const buff of this.state.buffs.values()) {\r\n      if (buff.type === 'good_impression') {\r\n        buff.stacks = Math.floor(buff.stacks * multiplier);\r\n        EventBus.emit(GameEvents.BUFF_UPDATED, { buff });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 条件效果\r\n   */\r\n  private async executeConditionalEffect(\r\n    effect: SkillCardEffect,\r\n    card: SkillCard,\r\n    result: EffectExecutionResult,\r\n  ): Promise<void> {\r\n    const { condition, trueEffect, falseEffect } = effect.metadata as any;\r\n\r\n    if (this.checkCondition(condition)) {\r\n      // 条件满足，执行trueEffect\r\n      const effectResult = await this.executeEffect(trueEffect, card);\r\n      this.mergeResults(result, effectResult);\r\n    } else if (falseEffect) {\r\n      // 条件不满足，执行falseEffect\r\n      const effectResult = await this.executeEffect(falseEffect, card);\r\n      this.mergeResults(result, effectResult);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 链式效果\r\n   */\r\n  private async executeChainEffect(\r\n    effect: SkillCardEffect,\r\n    card: SkillCard,\r\n    result: EffectExecutionResult,\r\n  ): Promise<void> {\r\n    const { effects } = effect.metadata as any;\r\n\r\n    for (const chainEffect of effects) {\r\n      const effectResult = await this.executeEffect(chainEffect, card);\r\n      this.mergeResults(result, effectResult);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 特殊效果（占位符，用于未来扩展）\r\n   */\r\n  private executeSpecialEffect(effect: SkillCardEffect, result: EffectExecutionResult): void {\r\n    console.log('[SkillCardExecutor] Special effect:', effect.metadata);\r\n  }\r\n\r\n  // ========== 辅助方法 ==========\r\n\r\n  /**\r\n   * 检查是否可以使用卡牌\r\n   */\r\n  private canUseCard(card: SkillCard): boolean {\r\n    // 检查本回合使用次数\r\n    if (this.state.turnState.cardsUsed >= this.state.turnState.maxCardsPerTurn) {\r\n      return false;\r\n    }\r\n\r\n    // 检查资源\r\n    const genkiCost = Math.abs(card.cost); // 元气消耗（负数转正）\r\n    const staminaCost = card.costType === 'stamina_only' ? Math.abs(card.cost) : 0;\r\n\r\n    return ResourceManager.hasEnoughResources(this.state, staminaCost, genkiCost);\r\n  }\r\n\r\n  /**\r\n   * 消耗卡牌Cost\r\n   */\r\n  private consumeCardCost(card: SkillCard): boolean {\r\n    const genkiCost = Math.abs(card.cost); // 元气消耗（负数转正）\r\n    const staminaCost = card.costType === 'stamina_only' ? Math.abs(card.cost) : 0;\r\n\r\n    // 消耗元气\r\n    if (genkiCost > 0) {\r\n      const success = ResourceManager.consumeGenki(this.state, genkiCost);\r\n      if (!success) return false;\r\n    }\r\n\r\n    // 消耗体力\r\n    if (staminaCost > 0) {\r\n      const success = ResourceManager.consumeStamina(this.state, staminaCost);\r\n      if (!success) return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 检查条件\r\n   */\r\n  private checkCondition(condition: EffectCondition): boolean {\r\n    switch (condition.type) {\r\n      case 'has_buff':\r\n        return BuffManager.hasBuff(this.state, condition.buffType!);\r\n\r\n      case 'has_no_buff':\r\n        return !BuffManager.hasBuff(this.state, condition.buffType!);\r\n\r\n      case 'stamina_above':\r\n        return this.state.stamina > (condition.value || 0);\r\n\r\n      case 'stamina_below':\r\n        return this.state.stamina < (condition.value || 0);\r\n\r\n      case 'genki_above':\r\n        return this.state.genki > (condition.value || 0);\r\n\r\n      case 'genki_below':\r\n        return this.state.genki < (condition.value || 0);\r\n\r\n      case 'concentration_above':\r\n        return this.attributeManager.get('concentration') > (condition.value || 0);\r\n\r\n      case 'motivation_above':\r\n        return this.attributeManager.get('motivation') > (condition.value || 0);\r\n\r\n      case 'all_power_full':\r\n        return this.attributeManager.get('allPower') >= 10;\r\n\r\n      case 'anomaly_state_is':\r\n        return this.state.attributes.anomalyState === condition.value;\r\n\r\n      case 'cards_in_hand_above':\r\n        return this.state.hand.length > (condition.value || 0);\r\n\r\n      case 'cards_in_discard_above':\r\n        return this.state.discardPile.length > (condition.value || 0);\r\n\r\n      case 'turn_number_above':\r\n        return this.state.currentTurn > (condition.value || 0);\r\n\r\n      case 'turn_number_below':\r\n        return this.state.currentTurn < (condition.value || 0);\r\n\r\n      default:\r\n        console.warn(`[SkillCardExecutor] Unknown condition type: ${condition.type}`);\r\n        return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 合并结果\r\n   */\r\n  private mergeResults(target: EffectExecutionResult, source: EffectExecutionResult): void {\r\n    if (!source.success) {\r\n      target.success = false;\r\n      target.message = source.message;\r\n      return;\r\n    }\r\n\r\n    const changes = target.changes!;\r\n    const sourceChanges = source.changes || {};\r\n\r\n    // 合并数值变化\r\n    if (sourceChanges.score) changes.score = (changes.score || 0) + sourceChanges.score;\r\n    if (sourceChanges.stamina) changes.stamina = (changes.stamina || 0) + sourceChanges.stamina;\r\n    if (sourceChanges.genki) changes.genki = (changes.genki || 0) + sourceChanges.genki;\r\n    if (sourceChanges.cardsDrawn) changes.cardsDrawn = (changes.cardsDrawn || 0) + sourceChanges.cardsDrawn;\r\n\r\n    // 合并Buff变化\r\n    if (sourceChanges.buffsAdded) {\r\n      changes.buffsAdded = [...(changes.buffsAdded || []), ...sourceChanges.buffsAdded];\r\n    }\r\n    if (sourceChanges.buffsRemoved) {\r\n      changes.buffsRemoved = [...(changes.buffsRemoved || []), ...sourceChanges.buffsRemoved];\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","/**\n * 战斗流程控制器\n *\n * 负责管理整个战斗的流程，包括回合管理、卡牌抽取、得分计算等\n */\nimport { EventBus, GameEvents } from '../utils/event-bus';\nimport { AttributeManager } from './attribute-manager';\nimport { BuffManager } from './buff-manager';\nimport { ResourceManager } from './resource-manager';\nimport { SkillCardExecutor } from './skill-card-executor';\nexport class BattleController {\n    state;\n    attributeManager;\n    executor;\n    constructor(config) {\n        this.state = this.initializeBattleState(config);\n        this.attributeManager = new AttributeManager(this.state);\n        this.executor = new SkillCardExecutor(this.state);\n    }\n    /**\n     * 初始化战斗状态\n     */\n    initializeBattleState(config) {\n        const state = {\n            id: `battle_${Date.now()}`,\n            mode: config.mode,\n            planType: config.planType,\n            currentTurn: 1,\n            maxTurns: config.maxTurns || 12,\n            startTime: Date.now(),\n            stamina: config.initialStamina || 60,\n            maxStamina: config.maxStamina || 60,\n            genki: 0,\n            attributes: {\n                concentration: 0,\n                motivation: 0,\n                goodImpression: 0,\n                allPower: 0,\n                heat: 0,\n                anomalyState: null,\n                stateLevel: 1,\n                pointerLocked: false,\n                energy: 0,\n            },\n            stats: { ...config.stats },\n            score: {\n                current: 0,\n                target: config.targetScore || 1000,\n                perfectTarget: config.perfectScore || 2000,\n            },\n            buffs: new Map(),\n            deck: [...config.skillDeck],\n            hand: [],\n            discardPile: [],\n            removedPile: [],\n            turnState: {\n                cardsUsed: 0,\n                maxCardsPerTurn: 1,\n                drawnThisTurn: 0,\n                attribute: null,\n                skippedActions: 0,\n            },\n            support: config.support || null,\n            history: [],\n            metadata: {},\n        };\n        // 洗牌\n        this.shuffleDeck(state.deck);\n        // 抽初始手牌（3张）\n        for (let i = 0; i < 3; i++) {\n            this.drawCard(state);\n        }\n        return state;\n    }\n    /**\n     * 开始战斗\n     */\n    start() {\n        EventBus.emit(GameEvents.BATTLE_STARTED, {\n            battleId: this.state.id,\n            mode: this.state.mode,\n            planType: this.state.planType,\n        });\n        this.addHistoryEntry('战斗开始', '', 0, 0, 0);\n    }\n    /**\n     * 开始回合\n     */\n    async startTurn() {\n        // 1. 回合数+1\n        if (this.state.currentTurn > 1) {\n            this.state.currentTurn++;\n        }\n        // 2. 重置回合状态\n        this.state.turnState = {\n            cardsUsed: 0,\n            maxCardsPerTurn: 1,\n            drawnThisTurn: 0,\n            attribute: this.state.mode === 'exam' ? this.determineExamAttribute() : null,\n            skippedActions: 0,\n        };\n        // 3. 触发回合开始Buff效果\n        BuffManager.updateBuffsOnTurnStart(this.state);\n        // 4. 抽牌（每回合抽2张）\n        for (let i = 0; i < 2; i++) {\n            this.drawCard(this.state);\n        }\n        // 5. 触发回合开始事件\n        EventBus.emit(GameEvents.TURN_STARTED, {\n            turn: this.state.currentTurn,\n            maxTurns: this.state.maxTurns,\n            attribute: this.state.turnState.attribute,\n        });\n        this.addHistoryEntry(`第${this.state.currentTurn}回合开始`, this.state.turnState.attribute ? `本回合属性：${this.state.turnState.attribute}` : '', 0, 0, 0);\n    }\n    /**\n     * 使用技能卡\n     */\n    async useCard(cardIndex) {\n        // 检查卡牌索引\n        if (cardIndex < 0 || cardIndex >= this.state.hand.length) {\n            console.error('[BattleController] Invalid card index');\n            return false;\n        }\n        const card = this.state.hand[cardIndex];\n        // 执行卡牌效果\n        const result = await this.executor.executeCard(card);\n        if (result.success) {\n            // 从手牌移除\n            this.state.hand.splice(cardIndex, 1);\n            // 移入弃牌堆\n            this.state.discardPile.push(card);\n            // 增加使用次数\n            this.state.turnState.cardsUsed++;\n            // 记录历史\n            this.addHistoryEntry(`使用卡牌：${card.name}`, `${card.description}`, result.changes?.score || 0, result.changes?.stamina || 0, result.changes?.genki || 0);\n            return true;\n        }\n        else {\n            console.error('[BattleController] Card execution failed:', result.message);\n            return false;\n        }\n    }\n    /**\n     * 跳过行动\n     */\n    async skipAction() {\n        this.state.turnState.skippedActions++;\n        // 跳过行动时获得5元气\n        ResourceManager.gainGenki(this.state, 5);\n        this.addHistoryEntry('跳过行动', '获得5元气', 0, 0, 5);\n        // 连续跳过3次则强制结束战斗\n        if (this.state.turnState.skippedActions >= 3) {\n            await this.endBattle();\n        }\n    }\n    /**\n     * 结束回合\n     */\n    async endTurn() {\n        // 1. 触发回合结束Buff效果（如好印象）\n        BuffManager.updateBuffsOnTurnEnd(this.state);\n        // 2. 弃置所有手牌\n        while (this.state.hand.length > 0) {\n            const card = this.state.hand.shift();\n            this.state.discardPile.push(card);\n            EventBus.emit(GameEvents.CARD_DISCARDED, { card });\n        }\n        // 3. 触发回合结束事件\n        EventBus.emit(GameEvents.TURN_ENDED, {\n            turn: this.state.currentTurn,\n            score: this.state.score.current,\n            stamina: this.state.stamina,\n            genki: this.state.genki,\n        });\n        this.addHistoryEntry(`第${this.state.currentTurn}回合结束`, `当前得分：${this.state.score.current}`, 0, 0, 0);\n        // 4. 检查是否结束战斗\n        if (this.shouldEndBattle()) {\n            await this.endBattle();\n        }\n    }\n    /**\n     * 结束战斗\n     */\n    async endBattle() {\n        const endTime = Date.now();\n        const duration = Math.floor((endTime - this.state.startTime) / 1000);\n        // 计算评价\n        const evaluation = this.calculateEvaluation();\n        // 计算排名（比赛模式）\n        let rank;\n        let rivalScores;\n        if (this.state.mode === 'exam') {\n            // TODO: 实现排名计算逻辑\n            rank = 1;\n            rivalScores = [];\n        }\n        // 计算奖励\n        const rewards = this.calculateRewards(evaluation);\n        // 创建结果\n        const result = {\n            mode: this.state.mode,\n            evaluation,\n            finalScore: this.state.score.current,\n            targetScore: this.state.score.target,\n            perfectScore: this.state.score.perfectTarget,\n            turns: this.state.currentTurn,\n            remainingStamina: this.state.stamina,\n            cardsUsed: this.state.history.filter(h => h.action.includes('使用卡牌')).length,\n            buffsGained: this.state.history.filter(h => h.action.includes('获得Buff')).length,\n            rank,\n            rivalScores,\n            stats: {\n                totalCardsUsed: this.state.history.filter(h => h.action.includes('使用卡牌')).length,\n                totalStaminaConsumed: -this.state.history.reduce((sum, h) => sum + h.staminaChange, 0),\n                totalGenkiGained: this.state.history.reduce((sum, h) => sum + h.genkiChange, 0),\n                totalBuffsGained: 0,\n                maxScore: Math.max(...this.state.history.map(h => h.scoreChange)),\n                averageScore: this.state.score.current / this.state.currentTurn,\n                perfectTurns: 0,\n            },\n            rewards,\n            startTime: this.state.startTime,\n            endTime,\n            duration,\n        };\n        // 触发战斗结束事件\n        EventBus.emit(GameEvents.BATTLE_ENDED, {\n            result,\n        });\n        this.addHistoryEntry('战斗结束', `最终得分：${this.state.score.current}`, 0, 0, 0);\n        return result;\n    }\n    // ========== 辅助方法 ==========\n    /**\n     * 抽牌\n     */\n    drawCard(state) {\n        if (state.hand.length >= 5)\n            return; // 手牌上限5张\n        // 如果牌堆为空，将弃牌堆洗入牌堆\n        if (state.deck.length === 0 && state.discardPile.length > 0) {\n            state.deck = [...state.discardPile];\n            state.discardPile = [];\n            this.shuffleDeck(state.deck);\n        }\n        if (state.deck.length === 0)\n            return; // 真的没牌了\n        const card = state.deck.shift();\n        state.hand.push(card);\n        state.turnState.drawnThisTurn++;\n        EventBus.emit(GameEvents.CARD_DRAWN, { card });\n    }\n    /**\n     * 洗牌（Fisher-Yates算法）\n     */\n    shuffleDeck(deck) {\n        for (let i = deck.length - 1; i > 0; i--) {\n            const j = Math.floor(Math.random() * (i + 1));\n            [deck[i], deck[j]] = [deck[j], deck[i]];\n        }\n    }\n    /**\n     * 确定考试回合属性（比赛模式）\n     */\n    determineExamAttribute() {\n        // 简单实现：随机或按照既定顺序\n        const attributes = ['vocal', 'dance', 'visual'];\n        const index = (this.state.currentTurn - 1) % 3;\n        return attributes[index];\n    }\n    /**\n     * 检查是否应该结束战斗\n     */\n    shouldEndBattle() {\n        // 回合数达到上限\n        if (this.state.currentTurn >= this.state.maxTurns) {\n            return true;\n        }\n        // 体力耗尽\n        if (this.state.stamina <= 0) {\n            return true;\n        }\n        return false;\n    }\n    /**\n     * 计算评价\n     */\n    calculateEvaluation() {\n        if (this.state.score.current >= this.state.score.perfectTarget) {\n            return 'perfect';\n        }\n        else if (this.state.score.current >= this.state.score.target) {\n            return 'clear';\n        }\n        else {\n            return 'fail';\n        }\n    }\n    /**\n     * 计算奖励\n     */\n    calculateRewards(evaluation) {\n        const multiplier = evaluation === 'perfect' ? 2 : evaluation === 'clear' ? 1 : 0.5;\n        return {\n            pPoints: Math.floor(this.state.score.current * 0.1 * multiplier),\n            pDrinks: [],\n            pItems: [],\n            skillCards: [],\n            statGain: {\n                vocal: Math.floor(Math.random() * 10 * multiplier),\n                dance: Math.floor(Math.random() * 10 * multiplier),\n                visual: Math.floor(Math.random() * 10 * multiplier),\n            },\n            love: Math.floor(5 * multiplier),\n        };\n    }\n    /**\n     * 添加历史记录\n     */\n    addHistoryEntry(action, description, scoreChange, staminaChange, genkiChange) {\n        this.state.history.push({\n            turn: this.state.currentTurn,\n            action,\n            description,\n            scoreChange,\n            staminaChange,\n            genkiChange,\n            timestamp: Date.now(),\n        });\n    }\n    // ========== Getters ==========\n    /**\n     * 获取当前战斗状态\n     */\n    getState() {\n        return this.state;\n    }\n    /**\n     * 获取当前回合数\n     */\n    getCurrentTurn() {\n        return this.state.currentTurn;\n    }\n    /**\n     * 获取手牌\n     */\n    getHand() {\n        return this.state.hand;\n    }\n    /**\n     * 获取当前得分\n     */\n    getScore() {\n        return this.state.score.current;\n    }\n    /**\n     * 获取历史记录\n     */\n    getHistory() {\n        return this.state.history;\n    }\n}\n","/**\n * 技能卡解析器\n *\n * 将299张真实技能卡数据解析为SkillCard对象\n */\n\nimport type { CardAttribute, CardRarity, SkillCard, SkillCardEffect } from '../types';\n\n// 导入技能卡数据库\nimport skillCardDatabase from './skill-cards.json';\n\nexport class SkillCardParser {\n  /**\n   * 解析所有技能卡\n   */\n  static parseAllCards(enhanced: boolean = false): SkillCard[] {\n    const cards: SkillCard[] = [];\n\n    // 遍历所有属性\n    for (const [attribute, rarities] of Object.entries(skillCardDatabase)) {\n      // 遍历所有品阶\n      for (const [rarity, cardList] of Object.entries(rarities as any)) {\n        for (const rawCard of cardList as any[]) {\n          const card = this.parseCard(rawCard, attribute as CardAttribute, enhanced);\n          if (card) {\n            cards.push(card);\n          }\n        }\n      }\n    }\n\n    return cards;\n  }\n\n  /**\n   * 按属性获取技能卡\n   */\n  static getCardsByAttribute(attribute: CardAttribute, enhanced: boolean = false): SkillCard[] {\n    const cards: SkillCard[] = [];\n    const attributeData = skillCardDatabase[attribute];\n\n    if (!attributeData) return cards;\n\n    for (const [rarity, cardList] of Object.entries(attributeData)) {\n      for (const rawCard of cardList as any[]) {\n        const card = this.parseCard(rawCard, attribute, enhanced);\n        if (card) {\n          cards.push(card);\n        }\n      }\n    }\n\n    return cards;\n  }\n\n  /**\n   * 按品阶获取技能卡\n   */\n  static getCardsByRarity(rarityFilter: CardRarity, enhanced: boolean = false): SkillCard[] {\n    const cards: SkillCard[] = [];\n\n    for (const [attribute, rarities] of Object.entries(skillCardDatabase)) {\n      const cardList = (rarities as any)[rarityFilter];\n      if (cardList) {\n        for (const rawCard of cardList) {\n          const card = this.parseCard(rawCard, attribute as CardAttribute, enhanced);\n          if (card) {\n            cards.push(card);\n          }\n        }\n      }\n    }\n\n    return cards;\n  }\n\n  /**\n   * 随机抽取N张卡牌\n   */\n  static getRandomCards(count: number, enhanced: boolean = false): SkillCard[] {\n    const allCards = this.parseAllCards(enhanced);\n    const shuffled = allCards.sort(() => Math.random() - 0.5);\n    return shuffled.slice(0, count);\n  }\n\n  /**\n   * 解析单张卡牌\n   */\n  private static parseCard(rawCard: any, attribute: CardAttribute, enhanced: boolean): SkillCard | null {\n    try {\n      const effectText = enhanced ? rawCard.effect_after : rawCard.effect_before;\n      const effects = this.parseEffects(effectText, attribute);\n\n      // 确定卡牌类型\n      const type = this.determineCardType(effectText);\n\n      // 检查是否\"重复不可\"\n      const unique = effectText.includes('重複不可') || effectText.includes('レッスン中1回');\n\n      // 获取Cost（已经是负数）\n      const cost = -Math.abs(parseInt(rawCard.cost) || 0);\n\n      // 确定Cost类型（默认为normal）\n      const costType = this.determineCostType(effectText);\n\n      // 生成卡牌ID\n      const cardId = `${attribute}_${rawCard.rarity}_${rawCard.id}${enhanced ? '_enhanced' : ''}`;\n\n      // 图片URL\n      const imageUrl = `https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/技能卡卡面/${rawCard.name}.webp`;\n\n      const card: SkillCard = {\n        id: cardId,\n        name: rawCard.name,\n        rarity: rawCard.rarity as CardRarity,\n        type,\n        attribute,\n        cost,\n        costType,\n        unique,\n        enhanced,\n        limitPerLesson: unique ? 1 : null,\n        usedThisLesson: 0,\n        effects,\n        description: effectText,\n        imageUrl,\n        source: 'official',\n      };\n\n      return card;\n    } catch (error) {\n      console.error('[SkillCardParser] Error parsing card:', rawCard.name, error);\n      return null;\n    }\n  }\n\n  /**\n   * 解析效果文本\n   */\n  private static parseEffects(effectText: string, attribute: CardAttribute): SkillCardEffect[] {\n    const effects: SkillCardEffect[] = [];\n\n    // ========== 属性增加 ==========\n    const paramMatch = effectText.match(/パラメータ\\+(\\d+)/g);\n    if (paramMatch) {\n      for (const match of paramMatch) {\n        const value = parseInt(match.match(/\\d+/)![0]);\n        effects.push({\n          type: 'add_score',\n          value: value, // 直接加分\n        });\n      }\n    }\n\n    // ========== 元气增加 ==========\n    const genkiMatch = effectText.match(/元気\\+(\\d+)/);\n    if (genkiMatch) {\n      effects.push({\n        type: 'gain_genki',\n        value: parseInt(genkiMatch[1]),\n      });\n    }\n\n    // ========== 体力回复 ==========\n    const staminaMatch = effectText.match(/体力回復(\\d+)/);\n    if (staminaMatch) {\n      effects.push({\n        type: 'recover_stamina',\n        value: parseInt(staminaMatch[1]),\n      });\n    }\n\n    // ========== 全力值增加 ==========\n    const allPowerMatch = effectText.match(/全力値\\+(\\d+)/);\n    if (allPowerMatch) {\n      effects.push({\n        type: 'add_all_power',\n        value: parseInt(allPowerMatch[1]),\n      });\n    }\n\n    // ========== 抽牌 ==========\n    const drawMatch = effectText.match(/スキルカードを(\\d+)枚引く/);\n    if (drawMatch) {\n      effects.push({\n        type: 'draw_cards',\n        value: parseInt(drawMatch[1]),\n      });\n    }\n\n    // ========== 额外使用次数 ==========\n    const extraUseMatch = effectText.match(/スキルカード使用数追加\\+(\\d+)/);\n    if (extraUseMatch) {\n      effects.push({\n        type: 'add_card_uses',\n        value: parseInt(extraUseMatch[1]),\n      });\n    }\n\n    // ========== 状态切换 ==========\n    if (effectText.includes('温存に変更')) {\n      const level = effectText.includes('温存2段階目') ? 2 : 1;\n      effects.push({\n        type: 'switch_anomaly_state',\n        metadata: { newState: 'conserve', level },\n      });\n    }\n    if (effectText.includes('強気に変更') || effectText.includes('強気2段階目')) {\n      const level = effectText.includes('強気2段階目') ? 2 : 1;\n      effects.push({\n        type: 'switch_anomaly_state',\n        metadata: { newState: 'resolute', level },\n      });\n    }\n\n    // ========== Buff相关 ==========\n    if (effectText.includes('消費体力減少')) {\n      const durationMatch = effectText.match(/消費体力減少(\\d+)ターン/);\n      const duration = durationMatch ? parseInt(durationMatch[1]) : 3;\n      effects.push({\n        type: 'add_buff',\n        metadata: { type: '体力消耗减少', duration },\n      });\n    }\n\n    // 如果没有解析到任何效果，添加一个默认效果\n    if (effects.length === 0) {\n      effects.push({\n        type: 'add_score',\n        value: 10,\n        metadata: { rawText: effectText },\n      });\n    }\n\n    return effects;\n  }\n\n  /**\n   * 确定卡牌类型\n   */\n  private static determineCardType(effectText: string): 'A' | 'M' | 'T' {\n    // 陷阱卡\n    if (effectText.includes('陷阱') || effectText.includes('トラップ')) {\n      return 'T';\n    }\n\n    // 精神型（通常有Buff、状态切换等）\n    if (\n      effectText.includes('好調') ||\n      effectText.includes('集中') ||\n      effectText.includes('好印象') ||\n      effectText.includes('消費体力減少')\n    ) {\n      return 'M';\n    }\n\n    // 默认为主动型\n    return 'A';\n  }\n\n  /**\n   * 确定Cost类型\n   */\n  private static determineCostType(effectText: string): 'normal' | 'stamina_only' {\n    // 如果明确提到消费体力，则为stamina_only\n    if (effectText.includes('消費体力') || effectText.includes('体力消費')) {\n      return 'stamina_only';\n    }\n    return 'normal';\n  }\n\n  /**\n   * 映射属性到V/D/V\n   */\n  private static mapAttributeToVDV(attribute: CardAttribute): 'vocal' | 'dance' | 'visual' {\n    switch (attribute) {\n      case '感性':\n        return 'vocal';\n      case '理性':\n        return 'dance';\n      case '非凡':\n        return 'visual';\n      case '自由':\n        return 'vocal'; // 自由卡默认映射到vocal\n      default:\n        return 'vocal';\n    }\n  }\n\n  /**\n   * 获取统计信息\n   */\n  static getStatistics(): {\n    totalCards: number;\n    byAttribute: Record<string, number>;\n    byRarity: Record<string, number>;\n  } {\n    const allCards = this.parseAllCards(false);\n\n    const byAttribute: Record<string, number> = {};\n    const byRarity: Record<string, number> = {};\n\n    for (const card of allCards) {\n      byAttribute[card.attribute] = (byAttribute[card.attribute] || 0) + 1;\n      byRarity[card.rarity] = (byRarity[card.rarity] || 0) + 1;\n    }\n\n    return {\n      totalCards: allCards.length,\n      byAttribute,\n      byRarity,\n    };\n  }\n}\n\n/**\n * 导出便捷方法\n */\n\n/**\n * 获取所有技能卡（未强化）\n */\nexport function getAllSkillCards(): SkillCard[] {\n  return SkillCardParser.parseAllCards(false);\n}\n\n/**\n * 获取所有技能卡（已强化）\n */\nexport function getAllEnhancedSkillCards(): SkillCard[] {\n  return SkillCardParser.parseAllCards(true);\n}\n\n/**\n * 创建初始牌组（30张）\n */\nexport function createStarterDeck(): SkillCard[] {\n  const n_cards = SkillCardParser.getCardsByRarity('N', false);\n  const r_cards = SkillCardParser.getCardsByRarity('R', false);\n\n  // 20张N卡 + 10张R卡\n  const deck: SkillCard[] = [];\n\n  // 随机选20张N卡\n  const shuffledN = n_cards.sort(() => Math.random() - 0.5);\n  deck.push(...shuffledN.slice(0, 20));\n\n  // 随机选10张R卡\n  const shuffledR = r_cards.sort(() => Math.random() - 0.5);\n  deck.push(...shuffledR.slice(0, 10));\n\n  return deck;\n}\n\n/**\n * 创建高级牌组（包含SSR）\n */\nexport function createAdvancedDeck(): SkillCard[] {\n  const sr_cards = SkillCardParser.getCardsByRarity('SR', false);\n  const ssr_cards = SkillCardParser.getCardsByRarity('SSR', false);\n  const r_cards = SkillCardParser.getCardsByRarity('R', false);\n\n  const deck: SkillCard[] = [];\n\n  // 5张SSR + 10张SR + 15张R\n  const shuffledSSR = ssr_cards.sort(() => Math.random() - 0.5);\n  deck.push(...shuffledSSR.slice(0, 5));\n\n  const shuffledSR = sr_cards.sort(() => Math.random() - 0.5);\n  deck.push(...shuffledSR.slice(0, 10));\n\n  const shuffledR = r_cards.sort(() => Math.random() - 0.5);\n  deck.push(...shuffledR.slice(0, 15));\n\n  return deck;\n}\n"],"names":["EventBus","events","Map","on","event","callback","this","has","set","get","push","off","callbacks","index","indexOf","splice","emit","args","error","console","once","onceCallback","clear","clearEvent","delete","GameEvents","ATTRIBUTE_CHANGED","ALL_POWER_FULL","STAMINA_CHANGED","GENKI_CHANGED","BUFF_ADDED","BUFF_REMOVED","BUFF_UPDATED","SCORE_CHANGED","CARD_USED","CARD_DRAWN","CARD_DISCARDED","CARD_REMOVED","TURN_STARTED","TURN_ENDED","BATTLE_STARTED","BATTLE_ENDED","ANOMALY_STATE_CHANGED","POINTER_LOCKED","POINTER_UNLOCKED","AttributeManager","state","constructor","add","attributeName","value","newValue","attributes","onAttributeChanged","consume","current","oldValue","Math","max","delta","triggerAllPowerTransform","allPower","anomalyState","stateLevel","planType","oldState","newState","level","switchAnomalyState","clearAnomalyState","lockPointer","pointerLocked","unlockPointer","reset","concentration","motivation","goodImpression","heat","energy","snapshot","BuffManager","addBuff","buff","existing","buffs","id","isStackableBuff","type","stacks","duration","triggerBuffEffects","removeBuff","buffId","consumeBuff","amount","updateBuffsOnTurnStart","buffsToRemove","entries","updateBuffsOnTurnEnd","values","trigger","context","buffEffect","effects","effect","name","getBuffEffect","buffType","total","hasBuff","getBuff","getPositiveBuffs","Array","from","filter","category","getNegativeBuffs","clearNegativeBuffs","negativeBuffs","clearAllBuffs","allBuffIds","keys","extendBuffDuration","turns","includes","getBuffCount","size","map","ResourceManager","recoverStamina","oldStamina","stamina","min","maxStamina","actualRecovered","consumeStamina","reduction","getStaminaReduction","actualCost","gainGenki","boostPercentage","getGenkiBoost","actualGain","floor","oldGenki","genki","actualAdded","consumeGenki","boost","setStamina","setGenki","increaseMaxStamina","hasEnoughResources","staminaCost","genkiCost","actualStaminaCost","BuffPresets","score","iconUrl","color","bonus","source","heatGain","allPowerGain","percentage","multiplier","createBuff","params","factory","SkillCardExecutor","attributeManager","executeCard","card","result","success","changes","canUseCard","message","consumeCardCost","hasDoubleEffect","effectMultiplier","i","effectResult","executeEffect","mergeResults","executeScoreMultiplier","executeGainStamina","executeGainGenki","executeAddBuff","executeDrawCards","executeExtraCardUse","executeExtraTurn","executeGainAllPower","executeGainHeat","executeChangeAnomalyState","executeLockPointer","executeConsumeStamina","executeConsumeConcentration","executeConsumeMotivation","executeConsumeAllPower","executeConsumeBuff","executeAmplifyScore","executeAmplifyGoodImpression","executeConditionalEffect","executeChainEffect","executeSpecialEffect","warn","attribute","metadata","attrValue","stats","recovered","gained","buffsAdded","drawn","hand","length","deck","shift","cardsDrawn","turnState","maxCardsPerTurn","maxTurns","consumed","buffsRemoved","oldScore","condition","trueEffect","falseEffect","checkCondition","chainEffect","log","cardsUsed","abs","cost","costType","discardPile","currentTurn","target","sourceChanges","Vue","BattleController","executor","config","initializeBattleState","Date","now","mode","startTime","initialStamina","targetScore","perfectTarget","perfectScore","skillDeck","removedPile","drawnThisTurn","skippedActions","support","history","shuffleDeck","drawCard","start","battleId","addHistoryEntry","startTurn","determineExamAttribute","turn","useCard","cardIndex","description","skipAction","endBattle","endTurn","shouldEndBattle","endTime","evaluation","calculateEvaluation","rank","rivalScores","rewards","calculateRewards","finalScore","remainingStamina","h","action","buffsGained","totalCardsUsed","totalStaminaConsumed","reduce","sum","staminaChange","totalGenkiGained","genkiChange","totalBuffsGained","maxScore","scoreChange","averageScore","perfectTurns","j","random","pPoints","pDrinks","pItems","skillCards","statGain","vocal","dance","visual","love","timestamp","getState","getCurrentTurn","getHand","getScore","getHistory","SkillCardParser","parseAllCards","enhanced","cards","rarities","Object","rarity","cardList","rawCard","parseCard","getCardsByAttribute","attributeData","getCardsByRarity","rarityFilter","getRandomCards","count","sort","slice","effectText","effect_after","effect_before","parseEffects","determineCardType","unique","parseInt","determineCostType","cardId","imageUrl","limitPerLesson","usedThisLesson","paramMatch","match","genkiMatch","staminaMatch","allPowerMatch","drawMatch","extraUseMatch","durationMatch","rawText","mapAttributeToVDV","getStatistics","allCards","byAttribute","byRarity","totalCards","getAllSkillCards","getAllEnhancedSkillCards","createStarterDeck","n_cards","r_cards","shuffledN","shuffledR","createAdvancedDeck","sr_cards","ssr_cards","shuffledSSR","shuffledSR"],"sourceRoot":""}
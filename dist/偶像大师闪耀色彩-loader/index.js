var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=$;var n=e.n(t);const s=toastr;var o=e.n(s);function r(e,t,n){const s={info:'ğŸ“˜',success:'âœ…',warn:'âš ï¸',error:'âŒ'}[e];console.log(`${s} [å¶åƒå¤§å¸ˆLoader] ${t}`),n&&console.log(n),'success'===e?o().success(t,'å¶åƒå¤§å¸ˆ',{timeOut:2e3}):'error'===e&&o().error(t,'å¶åƒå¤§å¸ˆ',{timeOut:3e3})}let a=null;function c(){const e=document.getElementById('idolmaster-game-iframe');if(e)return a=e,void r('info','æ¸¸æˆ iframe å·²å­˜åœ¨ï¼Œå¤ç”¨ä¸­');const t=document.createElement('iframe');t.id='idolmaster-game-iframe',t.src='https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“å/main/dist/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/index.html',t.style.cssText='\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    border: none;\n    z-index: 9999;\n    background: #000;\n  ',document.body.appendChild(t),a=t,r('success','æ¸¸æˆ iframe å·²åˆ›å»ºå¹¶åŠ è½½')}function i(){a&&(a.remove(),a=null,r('info','æ¸¸æˆ iframe å·²é”€æ¯'))}async function d(e,t){return r('info','æ­£åœ¨è°ƒç”¨ AIï¼ˆäº‹ä»¶ç›‘å¬æ¨¡å¼ï¼‰...',{prompt:e.substring(0,100)+'...',metadata:t}),new Promise(async(t,n)=>{let s=!1;const o=setTimeout(()=>{s||(a(),n(new Error('AI å“åº”è¶…æ—¶ï¼ˆ60ç§’ï¼‰')))},6e4);function a(){s||(s=!0,clearTimeout(o),eventOff(tavern_events.MESSAGE_RECEIVED,i))}const c=SillyTavern.chat?.length||0;function i(e){r('info','AI å“åº”äº‹ä»¶è§¦å‘',{messageId:e});const n=SillyTavern.chat;if(n&&n.length>c){const s=n[n.length-1];!1!==s.is_user&&'You'===s.name||(a(),r('success','AI å“åº”å·²æ”¶åˆ°',{messageId:e,content:s.mes.substring(0,100)+'...'}),t(s.mes))}}eventOn(tavern_events.MESSAGE_RECEIVED,i);try{await createChatMessages([{role:'user',content:e}]),r('info','æç¤ºè¯å·²æ·»åŠ åˆ°èŠå¤©è®°å½•'),await triggerSlash('/trigger'),r('info','AI ç”Ÿæˆå·²è§¦å‘')}catch(e){a(),r('error','AI è°ƒç”¨å¤±è´¥',e),n(e)}})}async function u(e){if(!a||e.source!==a.contentWindow)return;const{type:t,payload:n,requestId:s}=e.data;r('info',`æ”¶åˆ°æ¥è‡ª Vue çš„æ¶ˆæ¯: ${t}`,{requestId:s,metadata:n.metadata});try{if('GENERATE_SKILL_CARD'===t){const e=await d(n.prompt,n.metadata);let t;try{const n=e.match(/```(?:json)?\s*\n?([\s\S]*?)\n?```/);t=n?JSON.parse(n[1]):JSON.parse(e)}catch(t){throw r('error','AI å“åº”æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æä¸º JSON',{aiResponse:e}),new Error('AI å“åº”æ ¼å¼é”™è¯¯')}const o={type:'AI_SKILL_CARD_RESPONSE',payload:{requestId:s,skillData:t}};a.contentWindow.postMessage(o,'*'),r('success','æŠ€èƒ½å¡å“åº”å·²å‘é€',{skillData:t})}else'GENERATE_STORY'===t&&r('warn','å‰§æƒ…ç”ŸæˆåŠŸèƒ½å°šæœªå®ç°')}catch(e){r('error','å¤„ç†æ¶ˆæ¯å¤±è´¥',e);const t={type:'AI_ERROR',payload:{requestId:s,error:e instanceof Error?e.message:'æœªçŸ¥é”™è¯¯'}};a?.contentWindow&&a.contentWindow.postMessage(t,'*')}}n()(()=>{r('success','å¶åƒå¤§å¸ˆé€šä¿¡æ¡¥æ¥å™¨å·²åŠ è½½'),window.addEventListener('message',u),r('info','postMessage ç›‘å¬å™¨å·²æ¿€æ´»'),c(),eventOn(tavern_events.CHAT_CHANGED,()=>{r('info','èŠå¤©æ–‡ä»¶å·²å˜æ›´ï¼Œé‡æ–°åŠ è½½æ¸¸æˆ'),i(),setTimeout(()=>c(),500)})}),n()(window).on('pagehide',()=>{r('info','å¶åƒå¤§å¸ˆé€šä¿¡æ¡¥æ¥å™¨æ­£åœ¨å¸è½½'),window.removeEventListener('message',u),eventOff(tavern_events.CHAT_CHANGED,()=>{}),i(),r('success','å¶åƒå¤§å¸ˆé€šä¿¡æ¡¥æ¥å™¨å·²å¸è½½')}),window.IdolMasterLoader={createIframe:c,destroyIframe:i,testAI:async e=>{r('info','æµ‹è¯• AI è°ƒç”¨');try{const t=await d(e);return r('success','AI æµ‹è¯•æˆåŠŸ',{result:t}),t}catch(e){throw r('error','AI æµ‹è¯•å¤±è´¥',e),e}}},r('info','è°ƒè¯•å·¥å…·å·²æš´éœ²åˆ° window.IdolMasterLoader');
//# sourceMappingURL=index.js.map
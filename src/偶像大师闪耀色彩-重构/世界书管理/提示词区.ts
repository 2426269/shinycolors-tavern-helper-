/**
 * æç¤ºè¯åŒºï¼ˆç®€åŒ–ç‰ˆï¼‰
 * è´Ÿè´£ä¸ºAIç”Ÿæˆæ¨¡å¼æä¾›ç®€æ´æ˜ç¡®çš„æç¤ºè¯æ¡†æ¶
 */

/**
 * æç¤ºè¯æ¨¡å¼æšä¸¾
 */
export enum PromptMode {
  /** æŠ€èƒ½å¡ç”Ÿæˆæ¨¡å¼ */
  SKILL_CARD_GENERATION = 'skill_card_generation',
}

/**
 * æç¤ºè¯å˜é‡æ¥å£ï¼ˆç”¨äºåŠ¨æ€æ›¿æ¢ï¼‰
 */
export interface PromptVariables {
  /** è§’è‰²åç§° */
  characterName?: string;
  /** å¡ç‰Œç¨€æœ‰åº¦ */
  rarity?: string;
  /** åŸ¹è‚²è®¡åˆ’ */
  producePlan?: string;
  /** æ¨èæ‰“æ³• */
  recommendedStyle?: string;
  /** ç¤ºä¾‹å¡ç‰Œåˆ—è¡¨ï¼ˆMarkdownè¡¨æ ¼ï¼‰ */
  exampleCards?: string;
  /** å¡ç‰Œä¸»é¢˜/æ¦‚å¿µ */
  theme?: string;
  /** åŸ¹è‚²è®¡åˆ’æœºåˆ¶è¯´æ˜ï¼ˆMarkdownæ ¼å¼ï¼‰ */
  producePlanMechanic?: string;
}

/**
 * æç¤ºè¯ç®¡ç†å™¨
 */
export class PromptManager {
  /**
   * æŠ€èƒ½å¡ç”Ÿæˆæç¤ºè¯æ¡†æ¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
   */
  static getSkillCardGenerationPrompt(): string {
    return `# ä¸º {{characterName}} ç”Ÿæˆ {{rarity}} çº§æŠ€èƒ½å¡

**åŸ¹è‚²è®¡åˆ’**: {{producePlan}} | **æ‰“æ³•**: {{recommendedStyle}} | **ä¸»é¢˜**: {{theme}}

---

## ğŸ“‹ è¾“å‡ºæ ¼å¼ï¼ˆè¯æ¡å¼JSONï¼‰

**âš ï¸ ç›´æ¥è¾“å‡ºJSONï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ï¼**

\`\`\`json
{
  "id": "è§’è‰²è‹±æ–‡å_ssr_exclusive",
  "nameJP": "æ—¥æ–‡å",
  "nameCN": "ä¸­æ–‡å",
  "type": "ä¸»åŠ¨",
  "rarity": "{{rarity}}",
  "cost": "ä½“åŠ›æ¶ˆè€—X",
  "producePlan": "{{producePlan}}",

  "effectEntries": [
    {
      "icon": "",
      "effect": "æ•°å€¼+10",
      "isConsumption": false
    }
  ],

  "effectEntriesEnhanced": [
    {
      "icon": "",
      "effect": "æ•°å€¼+15",
      "isConsumption": false
    }
  ],

  "restrictions": {
    "isDuplicatable": true,
    "usesPerBattle": null
  },

  "flavor": "é£å‘³æ–‡æœ¬",
  "isExclusive": true,
  "exclusiveCharacter": "{{characterName}}"
}
\`\`\`

---

## ğŸ¯ å›¾æ ‡URLé€ŸæŸ¥

| æ•ˆæœç±»å‹ | å›¾æ ‡URL |
|---------|---------|
| å…ƒæ°” | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å…ƒæ°”.png\` |
| å¹²åŠ² | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å¹²åŠ².png\` |
| å¥½å°è±¡ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å¥½å°è±¡.png\` |
| é›†ä¸­ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/é›†ä¸­.png\` |
| å…¨åŠ›å€¼ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å…¨åŠ›å€¼.png\` |
| å¥½è°ƒ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å¥½è°ƒ.png\` |
| ç»å¥½è°ƒ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/ç»å¥½è°ƒ.png\` |
| å¼ºæ°” | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/å¼ºæ°”.png\` |
| æ¸©å­˜ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/æ¸©å­˜.png\` |
| æ¶ˆè´¹ä½“åŠ›å‡å°‘ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/æ¶ˆè´¹ä½“åŠ›å‡å°‘.png\` |
| æŠ€èƒ½å¡ä½¿ç”¨æ¬¡æ•°+1 | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/æŠ€èƒ½å¡ä½¿ç”¨æ¬¡æ•°åŠ ä¸€.png\` |
| æ‰‹ç‰Œ | \`https://raw.githubusercontent.com/2426269/shinycolors-assets-cdn/main/æ¸¸æˆå›¾æ ‡/æ‰‹ç‰Œ.png\` |
| æ•°å€¼/æ¡ä»¶ç­‰ | \`""\`ï¼ˆç©ºå­—ç¬¦ä¸²ï¼Œæ•°å€¼æ— ä¸“ç”¨å›¾æ ‡ï¼‰ |

---

## âš ï¸ æ ¸å¿ƒè§„åˆ™

### 1. å‘½åä¸ç®€ä»‹è§„åˆ™ï¼ˆğŸ”¥ æœ€é‡è¦ï¼é¿å…å¸¸è§é”™è¯¯ï¼‰
- âœ… **å¡ç‰Œåç§°å’Œflavorç®€ä»‹åªä¸è§’è‰²äººè®¾ã€ä¸»é¢˜æœ‰å…³**
- âŒ **ç¦æ­¢æ ¹æ®åŸ¹è‚²è®¡åˆ’å±æ€§å‘½å**ï¼ˆå¦‚ç†æ€§â†’æ¼”ç®—ã€éå‡¡â†’æŒ‘æˆ˜ã€æ„Ÿæ€§â†’æ„ŸåŠ¨ï¼‰
- âŒ **é”™è¯¯ç¤ºä¾‹**ï¼š"ç»ˆç‚¹è¶Šãˆã®æ¼”ç®—"ï¼ˆå› ä¸º"æ¼”ç®—"æ˜¯ä»"ç†æ€§"å±æ€§è”æƒ³çš„ï¼‰
- âœ… **æ­£ç¡®åšæ³•**ï¼š
  - å‘½åçµæ„Ÿæ¥æºï¼šè§’è‰²æ€§æ ¼ã€å¡ç‰Œä¸»é¢˜ã€è§’è‰²å°è¯ã€è§’è‰²æ•…äº‹èƒŒæ™¯
  - ä¾‹å¦‚æŸè§’è‰²çš„å¡ç‰Œä¸»é¢˜æ˜¯"èˆå°è¡¨æ¼”"ï¼Œå°±ç”¨èˆå°ç›¸å…³è¯æ±‡å‘½å
  - flavoræ–‡æœ¬æè¿°è§’è‰²åœ¨è¯¥åœºæ™¯çš„å¿ƒæƒ…ã€åŠ¨ä½œã€æƒ³æ³•ï¼Œä¸è¦æåˆ°"ç†æ€§è®¡åˆ’"è¿™ç±»å±æ€§è¯
- âš ï¸ å±æ€§åªå½±å“æŠ€èƒ½æ•ˆæœå†…å®¹ï¼Œä¸å½±å“å‘½åå’Œç®€ä»‹

### 2. è¯æ¡æ ¼å¼ï¼ˆæŠ€æœ¯è¦æ±‚ï¼‰
- âœ… effectEntries/effectEntriesEnhanced **å¿…é¡»æ˜¯éç©ºæ•°ç»„**
- âœ… æ¯ä¸ªè¯æ¡åŒ…å«ï¼šiconï¼ˆå›¾æ ‡URLæˆ–""ï¼‰ã€effectï¼ˆçº¯ä¸­æ–‡æè¿°ï¼‰ã€isConsumptionï¼ˆå¸ƒå°”å€¼ï¼‰
- âœ… effectç¤ºä¾‹ï¼š"æ•°å€¼+10"ã€"å…ƒæ°”+3"ã€"å˜æ›´ä¸ºå¼ºæ°”2æ®µ"ã€"æŠ½å–1å¼ æŠ€èƒ½å¡"
- âš ï¸ **æ•°å€¼æ•ˆæœçš„iconä½¿ç”¨ç©ºå­—ç¬¦ä¸²""**ï¼ˆæ•°å€¼æ²¡æœ‰ä¸“ç”¨å›¾æ ‡ï¼‰
- âš ï¸ **æŠ€èƒ½å¡ä½¿ç”¨æ¬¡æ•°+1æœ‰ä¸“ç”¨å›¾æ ‡**ï¼Œè¯·ä½¿ç”¨å¯¹åº”URL
- âŒ ç¦æ­¢æ—¥æ–‡ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿â†’æ•°å€¼ã€å…ƒæ°—â†’å…ƒæ°”ã€ã‚„ã‚‹æ°—â†’å¹²åŠ²ã€ãƒ¬ãƒƒã‚¹ãƒ³â†’æ¼”å‡º

### 3. å¡ç‰Œç±»å‹
- **ä¸»åŠ¨å¡(A)**ï¼šå¿…é¡»åŒ…å«"æ•°å€¼+X"è¯æ¡
- **ç²¾ç¥å¡(M)**ï¼šä¸åŒ…å«æ•°å€¼ï¼Œä»…èµ„æº/çŠ¶æ€æ•ˆæœ

### 4. é™åˆ¶ä¿¡æ¯
- isDuplicatableï¼šfalse=ä¸å¯é‡å¤è·å¾—ï¼Œtrue=å¯é‡å¤è·å¾—
- usesPerBattleï¼š1=æ¼”å‡ºä¸­é™1æ¬¡ï¼Œnull=æ— é™åˆ¶
- âš ï¸ ä¸è¦æ‰€æœ‰å¡éƒ½è®¾ä¸ºæ¼”å‡ºä¸­é™1æ¬¡

### 5. æ¨èæµæ´¾ç³»ç»Ÿï¼ˆğŸ”¥ é‡è¦ï¼ï¼‰

**æ¯ä¸ªå±æ€§æœ‰ä¸¤æ¡æµæ´¾è·¯çº¿ï¼Œå¿…é¡»ä¸“æ³¨å…¶ä¸­ä¸€æ¡ï¼Œå¦åˆ™ä¼šä¸¥é‡é™åˆ¶å¡ç‰Œå¼ºåº¦ï¼**

å½“å‰æ¨èæµæ´¾ï¼š**{{recommendedStyle}}**

#### ç†æ€§è®¡åˆ’
- **å¹²åŠ²æµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**å…ƒæ°”**å’Œ**å¹²åŠ²**ï¼Œå›´ç»•ç§¯ç´¯å¹²åŠ²å¹¶è½¬æ¢ä¸ºå…ƒæ°”æœ€ç»ˆæ‰“å‡ºå¤§é‡å¾—åˆ†
- **å¥½å°è±¡æµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**å¥½å°è±¡**ï¼Œå›´ç»•ç§¯ç´¯å’Œæ¶ˆè´¹å¥½å°è±¡æ¥è·å¾—å¼ºåŠ›æ•ˆæœ

#### éå‡¡è®¡åˆ’
- **å¼ºæ°”æµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**å¼ºæ°”**å’Œ**æ¸©å­˜**ï¼Œé€šè¿‡å¼ºæ°”å’Œæ¸©å­˜çš„ç›¸äº’åˆ‡æ¢è·å¾—**çƒ­æ„å€¼**æ¥æé«˜æ•°å€¼
- **å…¨åŠ›æµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**å…¨åŠ›å€¼**ï¼Œå›´ç»•å°½å¯èƒ½å¤šåœ°è·å¾—å…¨åŠ›å€¼å¹¶è¿›å…¥**å…¨åŠ›çŠ¶æ€**ï¼ˆåˆ†æ•°å€å¢200%ï¼‰

#### æ„Ÿæ€§è®¡åˆ’ï¼ˆç‰¹æ®Šï¼šåŒæµæ´¾é…åˆï¼‰
- **å¥½è°ƒæµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**å¥½è°ƒ/ç»å¥½è°ƒ**
  - **å¥½è°ƒ**ï¼šå›ºå®šæé«˜æ•°å€¼50%ï¼ˆæ— è®ºå¥½è°ƒå›åˆæ•°ï¼‰
  - **ç»å¥½è°ƒ**ï¼šåœ¨å¥½è°ƒçš„åŸºç¡€ä¸Šï¼Œæ ¹æ®ç°æœ‰å¥½è°ƒå›åˆæ•°é¢å¤–å¢åŠ ï¼ˆå¥½è°ƒå›åˆæ•°Ã—10%ï¼‰
  - ç¤ºä¾‹ï¼šå¥½è°ƒ3å›åˆ+ç»å¥½è°ƒ = 50% + (3Ã—10%) = 80%æå‡
- **é›†ä¸­æµæ´¾**ï¼šæ ¸å¿ƒèµ„æºæ˜¯**é›†ä¸­**ï¼Œæé«˜åŸºç¡€æ•°å€¼ï¼ˆå¦‚é›†ä¸­+3 = åŸºç¡€æ•°å€¼+3ï¼‰
- âš ï¸ **ç‰¹æ®Šæœºåˆ¶**ï¼šæ„Ÿæ€§è®¡åˆ’çš„å¥½è°ƒå’Œé›†ä¸­ç›¸äº’é…åˆï¼Œ"å·¦è„šè¸©å³è„š"
  - æ•´ä½“æ„ç­‘éœ€è¦ä¸¤ç§æµæ´¾éƒ½ç”¨ï¼ˆä¸€ä¸»ä¸€å‰¯ï¼‰æ‰èƒ½æ‰“å‡ºé«˜åˆ†
  - **ä½†å•å¼ å¡ç‰Œè®¾è®¡å¿…é¡»ä»¥å…¶ä¸­ä¸€ä¸ªæµæ´¾ä¸ºä¸»æ•ˆæœ**
  - æ ¹æ®æ¨èæµæ´¾å†³å®šè¿™å¼ å¡ä¸»è¦æä¾›å¥½è°ƒè¿˜æ˜¯é›†ä¸­

#### é€šç”¨ï¼ˆæ— å±æ€§ï¼‰
- é€šç”¨å¡å¯ä»¥åœ¨ä»»ä½•åŸ¹è‚²è®¡åˆ’ä¸­ä½¿ç”¨ï¼Œä½†ä¸å±äºä¸“å±æŠ€èƒ½å¡çš„è®¾è®¡èŒƒç•´

âš ï¸ **è®¾è®¡è§„åˆ™**ï¼š
1. æŠ€èƒ½å¡æ•ˆæœå¿…é¡»å›´ç»•æ¨èæµæ´¾çš„æ ¸å¿ƒèµ„æºè®¾è®¡
2. **å…¨åŠ›æµæ´¾**ï¼šæ ¸å¿ƒæ˜¯è·å¾—å…¨åŠ›å€¼å¹¶è¿›å…¥å…¨åŠ›çŠ¶æ€ï¼Œä¸åº”ä¸»è¦æä¾›å…ƒæ°”
3. **å¼ºæ°”æµæ´¾**ï¼šæ ¸å¿ƒæ˜¯å¼ºæ°”å’Œæ¸©å­˜çš„åˆ‡æ¢+çƒ­æ„å€¼ï¼Œä¸åº”æ··å…¥å…¨åŠ›å€¼
4. **å¥½å°è±¡æµæ´¾**ï¼šæ ¸å¿ƒæ˜¯å¥½å°è±¡èµ„æºï¼Œä¸åº”ä¸»è¦æä¾›å…ƒæ°”
5. **å¹²åŠ²æµæ´¾**ï¼šæ ¸å¿ƒæ˜¯å…ƒæ°”è½¬åŒ–ä¸ºå¹²åŠ²ï¼Œè¿™æ‰åº”è¯¥æä¾›å…ƒæ°”
6. **æ„Ÿæ€§è®¡åˆ’ï¼ˆç‰¹æ®Šï¼‰**ï¼š
   - æ¨èæµæ´¾æ˜¯"å¥½è°ƒ"â†’å¡ç‰Œä»¥å¥½è°ƒ/ç»å¥½è°ƒæ•ˆæœä¸ºä¸»ï¼ˆå¯é™„å¸¦å°‘é‡é›†ä¸­ï¼‰
   - æ¨èæµæ´¾æ˜¯"é›†ä¸­"â†’å¡ç‰Œä»¥é›†ä¸­æ•ˆæœä¸ºä¸»ï¼ˆå¯é™„å¸¦å°‘é‡å¥½è°ƒï¼‰
   - å•å¼ å¡ä¸èƒ½å¹³å‡æä¾›ä¸¤ç§æ•ˆæœï¼Œå¿…é¡»æœ‰æ˜ç¡®çš„ä¸»æ¬¡
7. å¯¹äºç†æ€§/éå‡¡è®¡åˆ’ï¼šè™½ç„¶åŒå±æ€§å¯ä»¥äº’ç”¨èµ„æºï¼Œä½†ä¸¤æ¡è·¯éƒ½èµ°ä¼šå¯¼è‡´å¼ºåº¦ä¸è¶³
8. ä¸“å±æŠ€èƒ½å¡åº”è¯¥æ˜¯è¯¥æµæ´¾çš„æ ¸å¿ƒçˆ†å‘/ç»ˆææŠ€èƒ½

### 5. åŸ¹è‚²è®¡åˆ’ç‰¹è‰²ï¼ˆ{{producePlan}}ï¼‰
{{producePlanMechanic}}

### 6. å¼ºåº¦è®¾è®¡
å‚è€ƒç¤ºä¾‹å¡çš„æ•ˆæœå¼ºåº¦ï¼Œç¡®ä¿ï¼š
- æ˜æ˜¾å¼ºäºä½ç¨€æœ‰åº¦ç¤ºä¾‹
- ä¸è¶…è¿‡é«˜ç¨€æœ‰åº¦ç¤ºä¾‹å¤ªå¤š
- URéœ€å…¨é¢è¶…è¶ŠSSRï¼ˆæ•°å€¼æå‡30-50%ï¼‰

---

## ğŸ“š ç¤ºä¾‹å¡å‚è€ƒ

{{exampleCards}}

---

## âœ… æœ€ç»ˆæ£€æŸ¥æ¸…å•

1. âš ï¸ effectEntries/effectEntriesEnhanced æ˜¯å¦éç©ºï¼Ÿ
2. âš ï¸ æ‰€æœ‰effectå­—æ®µæ˜¯å¦çº¯ä¸­æ–‡ï¼Ÿ
3. âš ï¸ iconå­—æ®µæ˜¯å¦æ­£ç¡®å¡«å†™ï¼ˆURLæˆ–""ï¼‰ï¼Ÿ
4. âš ï¸ isConsumptionæ˜¯å¦æ­£ç¡®æ ‡è®°ï¼Ÿ
5. âš ï¸ æ˜¯å¦ç¬¦åˆ{{producePlan}}è®¡åˆ’ç‰¹è‰²ï¼Ÿ
6. âš ï¸ æ˜¯å¦ä»…è¾“å‡ºJSONï¼ˆæ— è§£é‡Šæ–‡å­—ï¼‰ï¼Ÿ

**å†æ¬¡å¼ºè°ƒ**ï¼šeffectEntrieså’ŒeffectEntriesEnhancedæ•°ç»„ç»å¯¹ä¸èƒ½ä¸ºç©ºï¼
`;
  }

  /**
   * æ›¿æ¢æç¤ºè¯ä¸­çš„å˜é‡
   * @param template æç¤ºè¯æ¨¡æ¿
   * @param variables å˜é‡å¯¹è±¡
   * @returns æ›¿æ¢åçš„æç¤ºè¯
   */
  static replaceVariables(template: string, variables: PromptVariables): string {
    let result = template;

    // æ›¿æ¢æ‰€æœ‰å˜é‡
    Object.entries(variables).forEach(([key, value]) => {
      const placeholder = `{{${key}}}`;
      result = result.replaceAll(placeholder, value || '');
    });

    // æ¸…ç†æœªæ›¿æ¢çš„å ä½ç¬¦ï¼ˆæ›¿æ¢ä¸ºç©ºæˆ–é»˜è®¤å€¼ï¼‰
    result = result.replace(/\{\{[^}]+\}\}/g, 'ï¼ˆæœªæŒ‡å®šï¼‰');

    return result;
  }

  /**
   * è·å–æŒ‡å®šæ¨¡å¼çš„æç¤ºè¯ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼ï¼‰
   * @param mode æç¤ºè¯æ¨¡å¼
   * @returns Promise<string> æç¤ºè¯å†…å®¹
   */
  static async getPrompt(mode: PromptMode): Promise<string> {
    // å°è¯•è¯»å–ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
    try {
      const globalVars = getVariables({ type: 'global' });
      const customPromptKey = `prompt_${mode}`;

      if (typeof globalVars[customPromptKey] === 'string' && globalVars[customPromptKey].trim()) {
        console.log(`âœ… ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æ ¼å¼: ${mode}`);
        return globalVars[customPromptKey];
      }
    } catch (error) {
      console.warn('âš ï¸ è¯»å–è‡ªå®šä¹‰æç¤ºè¯æ ¼å¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼:', error);
    }

    // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰æ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
    switch (mode) {
      case PromptMode.SKILL_CARD_GENERATION:
        return this.getSkillCardGenerationPrompt();
      default:
        console.error(`âŒ æœªçŸ¥çš„æç¤ºè¯æ¨¡å¼: ${mode}`);
        return '';
    }
  }

  /**
   * è·å–æŒ‡å®šæ¨¡å¼çš„é»˜è®¤æç¤ºè¯ï¼ˆç”¨äºæ˜¾ç¤ºå’Œæ¢å¤ï¼‰
   */
  static getDefaultPrompt(mode: PromptMode): string {
    switch (mode) {
      case PromptMode.SKILL_CARD_GENERATION:
        return this.getSkillCardGenerationPrompt();
      default:
        return '';
    }
  }

  /**
   * è·å–æ¨¡å¼å¯¹åº”çš„åç§°
   */
  private static getModeName(mode: PromptMode): string {
    const modeNames: Record<PromptMode, string> = {
      [PromptMode.SKILL_CARD_GENERATION]: 'æŠ€èƒ½å¡ç”Ÿæˆæç¤ºè¯',
    };
    return modeNames[mode] || 'æœªçŸ¥æ¨¡å¼æç¤ºè¯';
  }
}
